<!DOCTYPE html>
<html>
<body>

<head>
    <link rel="stylesheet" href="style.css">
</head>

<div class="topimg">
    <div class="imgcorner-text">Flowfield Pathfinding</div>
</div>

<div class="topnav">
    <a onclick="changePage(this)">Introduction</a>
    <div class="dropdown">
        <button class="dropdown-btn">Steps</button>
        <div class="dropdown-content">
            <a onclick="changePage(this)">Map Partitioning</a>
            <a onclick="changePage(this)">Cost Field</a>
            <a onclick="changePage(this)">Portal Generation</a>
            <a onclick="changePage(this)">Approximate Path Calculation</a>
            <a onclick="changePage(this)">Integration Field</a>
            <a onclick="changePage(this)">Flow Field</a>
        </div>
    </div>
    <a onclick="changePage(this)">References</a>
    <a onclick="changePage(this)">About</a>
</div>

<div class="infobox" data-title="Introduction">
    <h1>Introduction</h1>
    <p>Crowd pathfinding and steering using flow field tiles is a technique that solves the computational
        problem of moving hundreds to thousands of individual agents across massive
        maps. Through the use of dynamic flow field tiles, a more modern steering pipeline can be
        achieved with features such as obstacle avoidance, flocking, dynamic formations, crowd
        behavior, and support for arbitrary physics forces, all without the heavy CPU burden of
        repeatedly rebuilding individual paths for each agent.</p>

    <div class="fig-container" style="text-align: center">
        <figure>
            <img src="img/144littleguys.png" alt="" style="max-height: 600px">
            <figcaption>144 agents travelling towards the center of a maze.</figcaption>
        </figure>
    </div>

    <div class="vid-container" style="text-align: center">
        <video width="1280" height="720" controls style="align-content: center">
            <source src="video/example.mp4" type="video/mp4">
            Your browser does not support the video tag.
        </video>
    </div>

    <p>The purpose of this website is to showcase sections from an implementation of the flowfield pathfinding
    algorithm in Roblox Studio using the Lua programming language.</p>
</div>

<div class="infobox" data-title="Map Partitioning">
    <h1>Map Partitioning</h1>
    <p>
        To be able to efficiently calculate the path from a source position to a target, the map is divided into sectors
        and then further divided into cells which will hold the data required to query the direction in which an agent should travel.
    </p>

    <div class="fig-container" style="text-align: center">
        <figure>
            <img src="img/mapgen1.png" alt="">
            <figcaption>Map division into 64x64 unit sectors. Each sector gets assigned its own ID.</figcaption>
        </figure>
        <figure>
            <img src="img/mapgen2.png" alt="">
            <figcaption>Division of sector into 4x4 unit cells.</figcaption>
        </figure>
    </div>

    <p>
        In my case, I'm using a sector size of 64x64 ingame units which hold cells of size 4x4. This offers a decent balance
        between pathfinding accuracy and performance.
    </p>
</div>

<div class="infobox" data-title="Cost Field">
    <h1>Cost Field</h1>
    <p>
        The cost field contains information about how difficult a certain portion of the terrain is to traverse.
        Each cell gets assigned a value from 1 to 255 based on the slope of the terrain at the cell's position.
        The cost is weighted using a cubic function to lessen the impact that small slopes have on path calculation
        and to make steep slopes harder to traverse.
        If there's an obstacle inside of the cell, the cost value for that cell gets set to 255, marking it as impassable.
    </p>

    <div class="fig-container" style="text-align: center">
        <figure>
            <img src="img/costexample1.png" alt="">
            <figcaption>An example of how cost is assigned to slopes.
                Notice how the cell colors change based on the angle of the slopes to reflect the higher cost of traversing them.</figcaption>
        </figure>
        <figure>
            <img src="img/costexample2.png" alt="">
            <figcaption>The game considers both the house and the wall as obstacles and assigns them the maximum cost of 255.</figcaption>
        </figure>
    </div>

    <p>The implementation for the cost field calculation is as follows:</p>

    <!-- HTML generated using hilite.me --><div style="background: #f8f8f8; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%;"><span></span><span style="color: #008000; font-weight: bold">function</span><span style="color: #BBB"> </span><span style="color: #00F; font-weight: bold">SectorInfo</span>:<span style="color: #00F">CalculateCostField</span>(<span style="color: #19177C">obstacleParams</span>:<span style="color: #BBB"> </span>RaycastParams,<span style="color: #BBB"> </span><span style="color: #19177C">terrainParams</span>:<span style="color: #BBB"> </span>RaycastParams)
    <span style="color: #BBB">	</span><span style="color: #008000; font-weight: bold">local</span><span style="color: #BBB"> </span><span style="color: #19177C">eps</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #666">0.05</span>

    <span style="color: #BBB">	</span><span style="color: #008000; font-weight: bold">for</span><span style="color: #BBB"> </span><span style="color: #19177C">i</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #666">1</span>,<span style="color: #BBB"> </span><span style="color: #19177C">cellCount</span><span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">do</span>
    <span style="color: #BBB">		</span><span style="color: #008000; font-weight: bold">if</span><span style="color: #BBB"> </span><span style="color: #19177C">self</span>.Heightmap[<span style="color: #19177C">i</span>]<span style="color: #BBB"> </span><span style="color: #666">==</span><span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">nil</span><span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">then</span>
    <span style="color: #BBB">			</span><span style="color: #19177C">self</span>.Heightmap[<span style="color: #19177C">i</span>]<span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span>{}
    <span style="color: #BBB">		</span><span style="color: #008000; font-weight: bold">end</span>

    <span style="color: #BBB">		</span><span style="color: #008000; font-weight: bold">if</span><span style="color: #BBB"> </span><span style="color: #19177C">self</span>.CostField[<span style="color: #19177C">i</span>]<span style="color: #BBB"> </span><span style="color: #666">==</span><span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">nil</span><span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">then</span>
    <span style="color: #BBB">			</span><span style="color: #19177C">self</span>.CostField[<span style="color: #19177C">i</span>]<span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span>{}
    <span style="color: #BBB">		</span><span style="color: #008000; font-weight: bold">end</span>

    <span style="color: #BBB">		</span><span style="color: #008000; font-weight: bold">for</span><span style="color: #BBB"> </span><span style="color: #19177C">j</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #666">1</span>,<span style="color: #BBB"> </span><span style="color: #19177C">cellCount</span><span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">do</span>
    <span style="color: #BBB">			</span><span style="color: #19177C">self</span>.Heightmap[<span style="color: #19177C">i</span>][<span style="color: #19177C">j</span>]<span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #666">0</span>

    <span style="color: #BBB">			</span><span style="color: #008000; font-weight: bold">local</span><span style="color: #BBB"> </span><span style="color: #19177C">cellCenter</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">Vector3</span>.<span style="color: #00F">new</span>(<span style="color: #19177C">i</span><span style="color: #BBB"> </span><span style="color: #666">-</span><span style="color: #BBB"> </span><span style="color: #666">1</span>,<span style="color: #BBB"> </span><span style="color: #666">0</span>,<span style="color: #BBB"> </span><span style="color: #19177C">j</span><span style="color: #BBB"> </span><span style="color: #666">-</span><span style="color: #BBB"> </span><span style="color: #666">1</span>)<span style="color: #BBB"> </span><span style="color: #666">*</span><span style="color: #BBB"> </span><span style="color: #19177C">cellSize</span><span style="color: #BBB"> </span><span style="color: #666">+</span><span style="color: #BBB"> </span><span style="color: #19177C">Vector3</span>.<span style="color: #00F">new</span>(<span style="color: #19177C">self</span>.Position.X,<span style="color: #BBB"> </span><span style="color: #666">0</span>,<span style="color: #BBB"> </span><span style="color: #19177C">self</span>.Position.Y)<span style="color: #BBB"> </span><span style="color: #666">*</span><span style="color: #BBB"> </span><span style="color: #19177C">sectorSize</span><span style="color: #BBB"> </span><span style="color: #666">+</span><span style="color: #BBB"> </span><span style="color: #19177C">Vector3</span>.<span style="color: #00F">new</span>(<span style="color: #19177C">cellSize</span>,<span style="color: #BBB"> </span><span style="color: #666">0</span>,<span style="color: #BBB"> </span><span style="color: #19177C">cellSize</span>)<span style="color: #BBB"> </span><span style="color: #666">/</span><span style="color: #BBB"> </span><span style="color: #666">2</span>
    <span style="color: #BBB">			</span>
    <span style="color: #BBB">			</span><span style="color: #008000; font-weight: bold">local</span><span style="color: #BBB"> </span><span style="color: #19177C">obstacles</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">workspace</span>:<span style="color: #00F">Spherecast</span>(
    <span style="color: #BBB">				</span><span style="color: #19177C">cellCenter</span><span style="color: #BBB"> </span><span style="color: #666">-</span><span style="color: #BBB"> </span><span style="color: #19177C">Vector3</span>.yAxis<span style="color: #BBB"> </span><span style="color: #666">*</span><span style="color: #BBB"> </span><span style="color: #666">128</span>,
    <span style="color: #BBB">				</span><span style="color: #19177C">cellSize</span><span style="color: #BBB"> </span><span style="color: #666">/</span><span style="color: #BBB"> </span><span style="color: #666">2</span><span style="color: #BBB"> </span><span style="color: #666">-</span><span style="color: #BBB"> </span><span style="color: #19177C">eps</span>,<span style="color: #BBB"> </span>
    <span style="color: #BBB">				</span><span style="color: #19177C">Vector3</span>.<span style="color: #00F">new</span>(<span style="color: #666">0</span>,<span style="color: #BBB"> </span><span style="color: #666">512</span>,<span style="color: #BBB"> </span><span style="color: #666">0</span>),
    <span style="color: #BBB">				</span><span style="color: #19177C">obstacleParams</span>
    <span style="color: #BBB">			</span>)
    <span style="color: #BBB">			</span>
    <span style="color: #BBB">			</span><span style="color: #008000; font-weight: bold">if</span><span style="color: #BBB"> </span><span style="color: #19177C">obstacles</span><span style="color: #BBB"> </span><span style="color: #666">~=</span><span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">nil</span><span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">then</span>
    <span style="color: #BBB">				</span><span style="color: #19177C">self</span>.CostField[<span style="color: #19177C">i</span>][<span style="color: #19177C">j</span>]<span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">SectorInfo</span>.MaxCost
    <span style="color: #BBB">			</span><span style="color: #008000; font-weight: bold">else</span>
    <span style="color: #BBB">				</span><span style="color: #19177C">self</span>.CostField[<span style="color: #19177C">i</span>][<span style="color: #19177C">j</span>]<span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #666">1</span>
    <span style="color: #BBB">			</span><span style="color: #008000; font-weight: bold">end</span>

    <span style="color: #BBB">			</span><span style="color: #008000; font-weight: bold">local</span><span style="color: #BBB"> </span><span style="color: #19177C">ray</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">workspace</span>:<span style="color: #00F">Raycast</span>(<span style="color: #19177C">cellCenter</span><span style="color: #BBB"> </span><span style="color: #666">+</span><span style="color: #BBB"> </span><span style="color: #19177C">Vector3</span>.yAxis<span style="color: #BBB"> </span><span style="color: #666">*</span><span style="color: #BBB"> </span><span style="color: #666">512</span>,<span style="color: #BBB"> </span><span style="color: #666">-</span><span style="color: #19177C">Vector3</span>.yAxis<span style="color: #BBB"> </span><span style="color: #666">*</span><span style="color: #BBB"> </span><span style="color: #666">1024</span>,<span style="color: #BBB"> </span><span style="color: #19177C">terrainParams</span>)

    <span style="color: #BBB">			</span><span style="color: #008000; font-weight: bold">if</span><span style="color: #BBB"> </span><span style="color: #19177C">ray</span><span style="color: #BBB"> </span><span style="color: #666">==</span><span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">nil</span><span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">then</span>
    <span style="color: #BBB">				</span><span style="color: #19177C">continue</span>
    <span style="color: #BBB">			</span><span style="color: #008000; font-weight: bold">end</span>

    <span style="color: #BBB">			</span><span style="color: #19177C">self</span>.Heightmap[<span style="color: #19177C">i</span>][<span style="color: #19177C">j</span>]<span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">ray</span>.Position.Y

    <span style="color: #BBB">			</span><span style="color: #008000; font-weight: bold">if</span><span style="color: #BBB"> </span><span style="color: #19177C">self</span>.CostField[<span style="color: #19177C">i</span>][<span style="color: #19177C">j</span>]<span style="color: #BBB"> </span><span style="color: #666">==</span><span style="color: #BBB"> </span><span style="color: #19177C">SectorInfo</span>.MaxCost<span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">then</span>
    <span style="color: #BBB">				</span><span style="color: #19177C">continue</span>
    <span style="color: #BBB">			</span><span style="color: #008000; font-weight: bold">end</span>

    <span style="color: #BBB">			</span><span style="color: #008000; font-weight: bold">local</span><span style="color: #BBB"> </span><span style="color: #19177C">terrainObj</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">ray</span>.Instance
    <span style="color: #BBB">			</span><span style="color: #008000; font-weight: bold">local</span><span style="color: #BBB"> </span><span style="color: #19177C">x</span>,<span style="color: #BBB"> </span><span style="color: #19177C">y</span>,<span style="color: #BBB"> </span><span style="color: #19177C">z</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">terrainObj</span>.Size.X,<span style="color: #BBB"> </span><span style="color: #19177C">terrainObj</span>.Size.Y,<span style="color: #BBB"> </span><span style="color: #19177C">terrainObj</span>.Size.Z
    <span style="color: #BBB">			</span><span style="color: #008000; font-weight: bold">local</span><span style="color: #BBB"> </span><span style="color: #19177C">slopeLen</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">nil</span>
    <span style="color: #BBB">			</span><span style="color: #008000; font-weight: bold">if</span><span style="color: #BBB"> </span><span style="color: #19177C">terrainObj</span>:<span style="color: #00F">IsA</span>(<span style="color: #BA2121">&quot;WedgePart&quot;</span>)<span style="color: #BBB"> </span><span style="color: #A2F; font-weight: bold">or</span><span style="color: #BBB"> </span>(<span style="color: #19177C">terrainObj</span>:<span style="color: #00F">IsA</span>(<span style="color: #BA2121">&quot;Part&quot;</span>)<span style="color: #BBB"> </span><span style="color: #A2F; font-weight: bold">and</span><span style="color: #BBB"> </span><span style="color: #19177C">terrainObj</span>.Shape<span style="color: #BBB"> </span><span style="color: #666">==</span><span style="color: #BBB"> </span><span style="color: #19177C">Enum</span>.PartType.Wedge)<span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">then</span>
    <span style="color: #BBB">				</span><span style="color: #19177C">slopeLen</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #008000">math.sqrt</span>(<span style="color: #19177C">y</span><span style="color: #BBB"> </span><span style="color: #666">*</span><span style="color: #BBB"> </span><span style="color: #19177C">y</span><span style="color: #BBB"> </span><span style="color: #666">+</span><span style="color: #BBB"> </span><span style="color: #19177C">z</span><span style="color: #BBB"> </span><span style="color: #666">*</span><span style="color: #BBB"> </span><span style="color: #19177C">z</span>)
    <span style="color: #BBB">			</span><span style="color: #008000; font-weight: bold">elseif</span><span style="color: #BBB"> </span><span style="color: #19177C">terrainObj</span>:<span style="color: #00F">IsA</span>(<span style="color: #BA2121">&quot;CornerWedgePart&quot;</span>)<span style="color: #BBB"> </span><span style="color: #A2F; font-weight: bold">or</span><span style="color: #BBB"> </span>(<span style="color: #19177C">terrainObj</span>:<span style="color: #00F">IsA</span>(<span style="color: #BA2121">&quot;Part&quot;</span>)<span style="color: #BBB"> </span><span style="color: #A2F; font-weight: bold">and</span><span style="color: #BBB"> </span><span style="color: #19177C">terrainObj</span>.Shape<span style="color: #BBB"> </span><span style="color: #666">==</span><span style="color: #BBB"> </span><span style="color: #19177C">Enum</span>.PartType.CornerWedge)<span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">then</span>
    <span style="color: #BBB">				</span><span style="color: #008000; font-weight: bold">local</span><span style="color: #BBB"> </span><span style="color: #19177C">baseLen</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #008000">math.max</span>(<span style="color: #19177C">x</span>,<span style="color: #BBB"> </span><span style="color: #19177C">z</span>)
    <span style="color: #BBB">				</span><span style="color: #19177C">slopeLen</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #008000">math.sqrt</span>(<span style="color: #19177C">y</span><span style="color: #BBB"> </span><span style="color: #666">*</span><span style="color: #BBB"> </span><span style="color: #19177C">y</span><span style="color: #BBB"> </span><span style="color: #666">+</span><span style="color: #BBB"> </span><span style="color: #19177C">baseLen</span><span style="color: #BBB"> </span><span style="color: #666">*</span><span style="color: #BBB"> </span><span style="color: #19177C">baseLen</span>)
    <span style="color: #BBB">			</span><span style="color: #008000; font-weight: bold">end</span>

    <span style="color: #BBB">			</span><span style="color: #008000; font-weight: bold">if</span><span style="color: #BBB"> </span><span style="color: #19177C">slopeLen</span><span style="color: #BBB"> </span><span style="color: #666">==</span><span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">nil</span><span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">then</span>
    <span style="color: #BBB">				</span><span style="color: #19177C">continue</span>
    <span style="color: #BBB">			</span><span style="color: #008000; font-weight: bold">end</span>

    <span style="color: #BBB">			</span><span style="color: #008000; font-weight: bold">local</span><span style="color: #BBB"> </span><span style="color: #19177C">slopeSine</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">y</span><span style="color: #BBB"> </span><span style="color: #666">/</span><span style="color: #BBB"> </span><span style="color: #19177C">slopeLen</span>
    <span style="color: #BBB">			</span><span style="color: #008000; font-weight: bold">local</span><span style="color: #BBB"> </span><span style="color: #19177C">t</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">slopeSine</span><span style="color: #BBB"> </span><span style="color: #666">*</span><span style="color: #BBB"> </span><span style="color: #666">2</span><span style="color: #BBB"> </span><span style="color: #666">/</span><span style="color: #BBB"> </span><span style="color: #008000">math.pi</span>
    <span style="color: #BBB">			</span><span style="color: #008000; font-weight: bold">local</span><span style="color: #BBB"> </span><span style="color: #19177C">slopeCost</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">math</span>.<span style="color: #00F">round</span>(<span style="color: #19177C">SectorInfo</span>.MaxCost<span style="color: #BBB"> </span><span style="color: #666">*</span><span style="color: #BBB"> </span><span style="color: #666">3</span><span style="color: #BBB"> </span><span style="color: #666">*</span><span style="color: #BBB"> </span>(<span style="color: #666">1</span><span style="color: #BBB"> </span><span style="color: #666">-</span><span style="color: #BBB"> </span><span style="color: #19177C">t</span>)<span style="color: #BBB"> </span><span style="color: #666">*</span><span style="color: #BBB"> </span><span style="color: #19177C">t</span><span style="color: #BBB"> </span><span style="color: #666">*</span><span style="color: #BBB"> </span><span style="color: #19177C">t</span><span style="color: #BBB"> </span><span style="color: #666">+</span><span style="color: #BBB"> </span><span style="color: #19177C">t</span><span style="color: #BBB"> </span><span style="color: #666">*</span><span style="color: #BBB"> </span><span style="color: #19177C">t</span><span style="color: #BBB"> </span><span style="color: #666">*</span><span style="color: #BBB"> </span><span style="color: #19177C">t</span>)
    <span style="color: #BBB">			</span><span style="color: #19177C">self</span>.CostField[<span style="color: #19177C">i</span>][<span style="color: #19177C">j</span>]<span style="color: #BBB"> </span><span style="color: #666">+=</span><span style="color: #BBB"> </span><span style="color: #19177C">slopeCost</span>
    <span style="color: #BBB">			</span><span style="color: #19177C">self</span>.CostField[<span style="color: #19177C">i</span>][<span style="color: #19177C">j</span>]<span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #008000">math.floor</span>(<span style="color: #19177C">self</span>.CostField[<span style="color: #19177C">i</span>][<span style="color: #19177C">j</span>])
    <span style="color: #BBB">		</span><span style="color: #008000; font-weight: bold">end</span>
    <span style="color: #BBB">	</span><span style="color: #008000; font-weight: bold">end</span>
    <span style="color: #008000; font-weight: bold">end</span>
    </pre></div>

    <p>The documentation for the casting functions implemented by the game engine can be found below:</p>
    <ul>
        <li><a href="https://create.roblox.com/docs/reference/engine/classes/WorldRoot#Spherecast">WorldRoot:Spherecast</a></li>
        <li><a href="https://create.roblox.com/docs/reference/engine/classes/WorldRoot#Raycast">WorldRoot:Raycast</a></li>
    </ul>

    <p>The cost calculation function is called inside of a function that initializes all cost fields.</p>

    <!-- HTML generated using hilite.me --><div style="background: #f8f8f8; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%;"><span></span><span style="color: #008000; font-weight: bold">local</span><span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">function</span><span style="color: #BBB"> </span><span style="color: #00F">InitializeCostField</span>()
    <span style="color: #BBB">	</span><span style="color: #19177C">debug</span>.<span style="color: #00F">profilebegin</span>(<span style="color: #BA2121">&quot;Cost Field Initialization&quot;</span>)
    <span style="color: #BBB">	</span><span style="color: #008000; font-weight: bold">for</span><span style="color: #BBB"> </span><span style="color: #19177C">i</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #666">-</span><span style="color: #19177C">sectorCount</span>,<span style="color: #BBB"> </span><span style="color: #19177C">sectorCount</span><span style="color: #BBB"> </span><span style="color: #666">-</span><span style="color: #BBB"> </span><span style="color: #666">1</span><span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">do</span>
    <span style="color: #BBB">		</span><span style="color: #19177C">sectorGrid</span>[<span style="color: #19177C">i</span>]<span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span>{}
    <span style="color: #BBB">		</span><span style="color: #19177C">debugChunk</span>[<span style="color: #19177C">i</span>]<span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span>{}
    <span style="color: #BBB">		</span><span style="color: #008000; font-weight: bold">for</span><span style="color: #BBB"> </span><span style="color: #19177C">j</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #666">-</span><span style="color: #19177C">sectorCount</span>,<span style="color: #BBB"> </span><span style="color: #19177C">sectorCount</span><span style="color: #BBB"> </span><span style="color: #666">-</span><span style="color: #BBB"> </span><span style="color: #666">1</span><span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">do</span><span style="color: #BBB">		</span>
    <span style="color: #BBB">			</span><span style="color: #008000; font-weight: bold">local</span><span style="color: #BBB"> </span><span style="color: #19177C">sectorPos</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">Vector2</span>.<span style="color: #00F">new</span>(<span style="color: #19177C">i</span>,<span style="color: #BBB"> </span><span style="color: #19177C">j</span>)

    <span style="color: #BBB">			</span><span style="color: #19177C">debugChunk</span>[<span style="color: #19177C">i</span>][<span style="color: #19177C">j</span>]<span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">DebugChunk</span>.<span style="color: #00F">new</span>()
    <span style="color: #BBB">			</span><span style="color: #008000; font-weight: bold">local</span><span style="color: #BBB"> </span><span style="color: #19177C">chunk</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">debugChunk</span>[<span style="color: #19177C">i</span>][<span style="color: #19177C">j</span>]

    <span style="color: #BBB">			</span><span style="color: #00F">DebugInsertProperties</span>(<span style="color: #19177C">chunk</span>.Display[<span style="color: #19177C">DebugEnums</span>.DebugDisplayMode.Sector],<span style="color: #BBB"> </span>{
    <span style="color: #BBB">				</span><span style="color: #19177C">Type</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">DebugEnums</span>.DebugObject.Plane,
    <span style="color: #BBB">				</span><span style="color: #19177C">SectorPosition</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">sectorPos</span>,
    <span style="color: #BBB">				</span><span style="color: #19177C">Position</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #00F">DebugGetSectorCenter</span>(<span style="color: #19177C">sectorPos</span>),
    <span style="color: #BBB">				</span><span style="color: #19177C">Size</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">sectorSize</span>,
    <span style="color: #BBB">				</span><span style="color: #19177C">Color</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">DebugSectorPlaneColor</span>
    <span style="color: #BBB">			</span>})

    <span style="color: #BBB">			</span><span style="color: #00F">DebugInsertProperties</span>(<span style="color: #19177C">chunk</span>.Display[<span style="color: #19177C">DebugEnums</span>.DebugDisplayMode.Sector],<span style="color: #BBB"> </span>{
    <span style="color: #BBB">				</span><span style="color: #19177C">Type</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">DebugEnums</span>.DebugObject.Text,
    <span style="color: #BBB">				</span><span style="color: #19177C">SectorPosition</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">sectorPos</span>,
    <span style="color: #BBB">				</span><span style="color: #19177C">Position</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #00F">DebugGetSectorCenter</span>(<span style="color: #19177C">sectorPos</span>),<span style="color: #BBB"> </span>
    <span style="color: #BBB">				</span><span style="color: #19177C">Text</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #BA2121">&quot;[&quot;</span><span style="color: #666">..</span><span style="color: #19177C">i</span><span style="color: #666">..</span><span style="color: #BA2121">&quot;|&quot;</span><span style="color: #666">..</span><span style="color: #19177C">j</span><span style="color: #666">..</span><span style="color: #BA2121">&quot;] &quot;</span><span style="color: #666">..</span><span style="color: #19177C">Utils</span>.<span style="color: #00F">ConvertSectorPosToNumber</span>(<span style="color: #19177C">sectorPos</span>),
    <span style="color: #BBB">				</span><span style="color: #19177C">FontSize</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #666">24</span>,
    <span style="color: #BBB">				</span><span style="color: #19177C">Color</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">DebugSectorPlaneColor</span>
    <span style="color: #BBB">			</span>})

    <span style="color: #BBB">			</span><span style="color: #19177C">sectorGrid</span>[<span style="color: #19177C">i</span>][<span style="color: #19177C">j</span>]<span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">SectorInfo</span>.<span style="color: #00F">new</span>(<span style="color: #19177C">sectorPos</span>)
    <span style="color: #BBB">			</span><span style="color: #19177C">sectorGrid</span>[<span style="color: #19177C">i</span>][<span style="color: #19177C">j</span>]:<span style="color: #00F">CalculateCostField</span>(<span style="color: #19177C">obstacleParams</span>,<span style="color: #BBB"> </span><span style="color: #19177C">terrainParams</span>)
    <span style="color: #BBB">		</span><span style="color: #008000; font-weight: bold">end</span>
    <span style="color: #BBB">	</span><span style="color: #008000; font-weight: bold">end</span>

    <span style="color: #BBB">	</span><span style="color: #008000; font-weight: bold">for</span><span style="color: #BBB"> </span><span style="color: #19177C">i</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #666">-</span><span style="color: #19177C">sectorCount</span>,<span style="color: #BBB"> </span><span style="color: #19177C">sectorCount</span><span style="color: #BBB"> </span><span style="color: #666">-</span><span style="color: #BBB"> </span><span style="color: #666">1</span><span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">do</span>
    <span style="color: #BBB">		</span><span style="color: #008000; font-weight: bold">for</span><span style="color: #BBB"> </span><span style="color: #19177C">j</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #666">-</span><span style="color: #19177C">sectorCount</span>,<span style="color: #BBB"> </span><span style="color: #19177C">sectorCount</span><span style="color: #BBB"> </span><span style="color: #666">-</span><span style="color: #BBB"> </span><span style="color: #666">1</span><span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">do</span>
    <span style="color: #BBB">			</span><span style="color: #008000; font-weight: bold">local</span><span style="color: #BBB"> </span><span style="color: #19177C">sectorPos</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">Vector2</span>.<span style="color: #00F">new</span>(<span style="color: #19177C">i</span>,<span style="color: #BBB"> </span><span style="color: #19177C">j</span>)
    <span style="color: #BBB">			</span><span style="color: #008000; font-weight: bold">if</span><span style="color: #BBB"> </span>(<span style="color: #19177C">i</span><span style="color: #BBB"> </span><span style="color: #666">+</span><span style="color: #BBB"> </span><span style="color: #19177C">j</span><span style="color: #BBB"> </span><span style="color: #666">+</span><span style="color: #BBB"> </span><span style="color: #666">2</span><span style="color: #BBB"> </span><span style="color: #666">*</span><span style="color: #BBB"> </span><span style="color: #19177C">sectorCount</span>)<span style="color: #BBB"> </span><span style="color: #666">%</span><span style="color: #BBB"> </span><span style="color: #666">2</span><span style="color: #BBB"> </span><span style="color: #666">==</span><span style="color: #BBB"> </span><span style="color: #666">0</span><span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">then</span>
    <span style="color: #BBB">				</span><span style="color: #3D7B7B; font-style: italic">--setup portals at every even sum of chunk coords</span>
    <span style="color: #BBB">				</span><span style="color: #3D7B7B; font-style: italic">--since we also generate portals at the neighbor edges</span>
    <span style="color: #BBB">				</span><span style="color: #3D7B7B; font-style: italic">--that are adjacent to the current sector position</span>
    <span style="color: #BBB">				</span><span style="color: #00F">GeneratePortals</span>(<span style="color: #19177C">sectorPos</span>)
    <span style="color: #BBB">			</span><span style="color: #008000; font-weight: bold">end</span>
    <span style="color: #BBB">		</span><span style="color: #008000; font-weight: bold">end</span>
    <span style="color: #BBB">	</span><span style="color: #008000; font-weight: bold">end</span>

    <span style="color: #BBB">	</span><span style="color: #008000; font-weight: bold">for</span><span style="color: #BBB"> </span><span style="color: #19177C">i</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #666">-</span><span style="color: #19177C">sectorCount</span>,<span style="color: #BBB"> </span><span style="color: #19177C">sectorCount</span><span style="color: #BBB"> </span><span style="color: #666">-</span><span style="color: #BBB"> </span><span style="color: #666">1</span><span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">do</span>
    <span style="color: #BBB">		</span><span style="color: #008000; font-weight: bold">for</span><span style="color: #BBB"> </span><span style="color: #19177C">j</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #666">-</span><span style="color: #19177C">sectorCount</span>,<span style="color: #BBB"> </span><span style="color: #19177C">sectorCount</span><span style="color: #BBB"> </span><span style="color: #666">-</span><span style="color: #BBB"> </span><span style="color: #666">1</span><span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">do</span>
    <span style="color: #BBB">			</span><span style="color: #008000; font-weight: bold">local</span><span style="color: #BBB"> </span><span style="color: #19177C">sectorPos</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">Vector2</span>.<span style="color: #00F">new</span>(<span style="color: #19177C">i</span>,<span style="color: #BBB"> </span><span style="color: #19177C">j</span>)
    <span style="color: #BBB">			</span><span style="color: #00F">DebugSetupSectorCostFieldDisplay</span>(<span style="color: #19177C">sectorPos</span>)
    <span style="color: #BBB">			</span><span style="color: #00F">ConnectPortalsFlood</span>(<span style="color: #19177C">sectorPos</span>)
    <span style="color: #BBB">		</span><span style="color: #008000; font-weight: bold">end</span>
    <span style="color: #BBB">	</span><span style="color: #008000; font-weight: bold">end</span>
    <span style="color: #BBB">	</span><span style="color: #19177C">debug</span>.<span style="color: #00F">profileend</span>()
    <span style="color: #008000; font-weight: bold">end</span>
    </pre></div>
</div>

<div class="infobox" data-title="Portal Generation">
    <h1>Portal Generation</h1>
    <p>A "portal" in the context of flowfield pathfinding represents a sector edge through which an agent can travel to an adjacent sector.
    Portal positions are established using the previously generated cost field by calculating the midpoints between obstacles at the edges of sectors.</p>

    <!-- HTML generated using hilite.me --><div style="background: #f8f8f8; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%;"><span></span><span style="color: #008000; font-weight: bold">local</span><span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">function</span><span style="color: #BBB"> </span><span style="color: #00F">GeneratePortals</span>(<span style="color: #19177C">sectorPos</span>:<span style="color: #BBB"> </span>Vector2)
    <span style="color: #BBB">	</span><span style="color: #19177C">debug</span>.<span style="color: #00F">profilebegin</span>(<span style="color: #BA2121">&quot;Portal Generation&quot;</span>)
    <span style="color: #BBB">	</span><span style="color: #008000; font-weight: bold">local</span><span style="color: #BBB"> </span><span style="color: #19177C">sector</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">sectorGrid</span>[<span style="color: #19177C">sectorPos</span>.X][<span style="color: #19177C">sectorPos</span>.Y]
    <span style="color: #BBB">	</span><span style="color: #19177C">sector</span>:<span style="color: #00F">ResetPortals</span>()

    <span style="color: #BBB">	</span><span style="color: #008000; font-weight: bold">for</span><span style="color: #BBB"> </span><span style="color: #19177C">idx</span>,<span style="color: #BBB"> </span><span style="color: #19177C">dir</span><span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">in</span><span style="color: #BBB"> </span><span style="color: #19177C">dirs</span><span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">do</span>
    <span style="color: #BBB">		</span><span style="color: #008000; font-weight: bold">local</span><span style="color: #BBB"> </span><span style="color: #19177C">adj</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">sectorPos</span><span style="color: #BBB"> </span><span style="color: #666">+</span><span style="color: #BBB"> </span><span style="color: #19177C">dir</span>
    <span style="color: #BBB">		</span><span style="color: #008000; font-weight: bold">if</span><span style="color: #BBB"> </span><span style="color: #A2F; font-weight: bold">not</span><span style="color: #BBB"> </span><span style="color: #19177C">Utils</span>.<span style="color: #00F">IsValidSectorPos</span>(<span style="color: #19177C">adj</span>)<span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">then</span>
    <span style="color: #BBB">			</span><span style="color: #19177C">continue</span>
    <span style="color: #BBB">		</span><span style="color: #008000; font-weight: bold">end</span>

    <span style="color: #BBB">		</span><span style="color: #008000; font-weight: bold">local</span><span style="color: #BBB"> </span><span style="color: #19177C">sectorAdj</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">sectorGrid</span>[<span style="color: #19177C">adj</span>.X][<span style="color: #19177C">adj</span>.Y]

    <span style="color: #BBB">		</span><span style="color: #008000; font-weight: bold">local</span><span style="color: #BBB"> </span><span style="color: #19177C">sideId</span>,<span style="color: #BBB"> </span><span style="color: #19177C">sideIdAdj</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">idx</span><span style="color: #BBB"> </span><span style="color: #666">-</span><span style="color: #BBB"> </span><span style="color: #666">1</span>,<span style="color: #BBB"> </span>(<span style="color: #19177C">idx</span><span style="color: #BBB"> </span><span style="color: #666">+</span><span style="color: #BBB"> </span><span style="color: #666">1</span>)<span style="color: #BBB"> </span><span style="color: #666">%</span><span style="color: #BBB"> </span><span style="color: #666">4</span>
    <span style="color: #BBB">		</span><span style="color: #008000; font-weight: bold">local</span><span style="color: #BBB"> </span><span style="color: #19177C">side</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">sector</span>:<span style="color: #00F">GetSideCosts</span>(<span style="color: #19177C">sideId</span>)
    <span style="color: #BBB">		</span><span style="color: #008000; font-weight: bold">local</span><span style="color: #BBB"> </span><span style="color: #19177C">sideAdj</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">sectorAdj</span>:<span style="color: #00F">GetSideCosts</span>(<span style="color: #19177C">sideIdAdj</span>)

    <span style="color: #BBB">		</span><span style="color: #19177C">sectorAdj</span>:<span style="color: #00F">ResetPortalSide</span>(<span style="color: #19177C">sideIdAdj</span>)

    <span style="color: #BBB">		</span><span style="color: #008000; font-weight: bold">local</span><span style="color: #BBB"> </span><span style="color: #19177C">openPos</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">nil</span>
    <span style="color: #BBB">		</span><span style="color: #008000; font-weight: bold">if</span><span style="color: #BBB"> </span><span style="color: #19177C">side</span>[<span style="color: #666">1</span>]<span style="color: #BBB"> </span><span style="color: #666">~=</span><span style="color: #BBB"> </span><span style="color: #19177C">SectorInfo</span>.MaxCost<span style="color: #BBB"> </span><span style="color: #A2F; font-weight: bold">and</span><span style="color: #BBB"> </span><span style="color: #19177C">sideAdj</span>[<span style="color: #666">1</span>]<span style="color: #BBB"> </span><span style="color: #666">~=</span><span style="color: #BBB"> </span><span style="color: #19177C">SectorInfo</span>.MaxCost<span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">then</span>
    <span style="color: #BBB">			</span><span style="color: #19177C">openPos</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #666">1</span>
    <span style="color: #BBB">		</span><span style="color: #008000; font-weight: bold">end</span>

    <span style="color: #BBB">		</span><span style="color: #008000; font-weight: bold">for</span><span style="color: #BBB"> </span><span style="color: #19177C">i</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #666">1</span>,<span style="color: #BBB"> </span><span style="color: #19177C">cellCount</span><span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">do</span>
    <span style="color: #BBB">			</span><span style="color: #008000; font-weight: bold">local</span><span style="color: #BBB"> </span><span style="color: #19177C">obstacle</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span>(<span style="color: #19177C">side</span>[<span style="color: #19177C">i</span>]<span style="color: #BBB"> </span><span style="color: #666">==</span><span style="color: #BBB"> </span><span style="color: #19177C">SectorInfo</span>.MaxCost<span style="color: #BBB"> </span><span style="color: #A2F; font-weight: bold">or</span><span style="color: #BBB"> </span><span style="color: #19177C">sideAdj</span>[<span style="color: #19177C">i</span>]<span style="color: #BBB"> </span><span style="color: #666">==</span><span style="color: #BBB"> </span><span style="color: #19177C">SectorInfo</span>.MaxCost)
    <span style="color: #BBB">			</span><span style="color: #008000; font-weight: bold">if</span><span style="color: #BBB"> </span>(<span style="color: #19177C">obstacle</span><span style="color: #BBB"> </span><span style="color: #666">==</span><span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">true</span>)<span style="color: #BBB"> </span><span style="color: #666">==</span><span style="color: #BBB"> </span>(<span style="color: #19177C">openPos</span><span style="color: #BBB"> </span><span style="color: #666">~=</span><span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">nil</span>)<span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">then</span>
    <span style="color: #BBB">				</span><span style="color: #008000; font-weight: bold">if</span><span style="color: #BBB"> </span><span style="color: #19177C">obstacle</span><span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">then</span>
    <span style="color: #BBB">					</span><span style="color: #008000; font-weight: bold">local</span><span style="color: #BBB"> </span><span style="color: #19177C">portalPos</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #008000">math.floor</span>((<span style="color: #19177C">i</span><span style="color: #BBB"> </span><span style="color: #666">+</span><span style="color: #BBB"> </span><span style="color: #19177C">openPos</span>)<span style="color: #BBB"> </span><span style="color: #666">/</span><span style="color: #BBB"> </span><span style="color: #666">2</span>)
    <span style="color: #BBB">					</span><span style="color: #19177C">sector</span>:<span style="color: #00F">AddPortal</span>(<span style="color: #19177C">portalPos</span>,<span style="color: #BBB"> </span><span style="color: #19177C">sideId</span>)
    <span style="color: #BBB">					</span><span style="color: #19177C">sectorAdj</span>:<span style="color: #00F">AddPortal</span>(<span style="color: #19177C">portalPos</span>,<span style="color: #BBB"> </span><span style="color: #19177C">sideIdAdj</span>)
    <span style="color: #BBB">					</span><span style="color: #19177C">openPos</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">nil</span>
    <span style="color: #BBB">				</span><span style="color: #008000; font-weight: bold">else</span>
    <span style="color: #BBB">					</span><span style="color: #19177C">openPos</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">i</span>
    <span style="color: #BBB">				</span><span style="color: #008000; font-weight: bold">end</span>
    <span style="color: #BBB">			</span><span style="color: #008000; font-weight: bold">end</span>
    <span style="color: #BBB">		</span><span style="color: #008000; font-weight: bold">end</span>

    <span style="color: #BBB">		</span><span style="color: #008000; font-weight: bold">if</span><span style="color: #BBB"> </span><span style="color: #19177C">openPos</span><span style="color: #BBB"> </span><span style="color: #666">~=</span><span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">nil</span><span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">then</span>
    <span style="color: #BBB">			</span><span style="color: #008000; font-weight: bold">local</span><span style="color: #BBB"> </span><span style="color: #19177C">portalPos</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #008000">math.floor</span>((<span style="color: #19177C">cellCount</span><span style="color: #BBB"> </span><span style="color: #666">+</span><span style="color: #BBB"> </span><span style="color: #19177C">openPos</span>)<span style="color: #BBB"> </span><span style="color: #666">/</span><span style="color: #BBB"> </span><span style="color: #666">2</span>)
    <span style="color: #BBB">			</span><span style="color: #19177C">sector</span>:<span style="color: #00F">AddPortal</span>(<span style="color: #19177C">portalPos</span>,<span style="color: #BBB"> </span><span style="color: #19177C">sideId</span>)
    <span style="color: #BBB">			</span><span style="color: #19177C">sectorAdj</span>:<span style="color: #00F">AddPortal</span>(<span style="color: #19177C">portalPos</span>,<span style="color: #BBB"> </span><span style="color: #19177C">sideIdAdj</span>)
    <span style="color: #BBB">		</span><span style="color: #008000; font-weight: bold">end</span>
    <span style="color: #BBB">	</span><span style="color: #008000; font-weight: bold">end</span>
    <span style="color: #BBB">	</span><span style="color: #19177C">debug</span>.<span style="color: #00F">profileend</span>()
    <span style="color: #008000; font-weight: bold">end</span>
    </pre></div>

    <p>The portals are then used to create a weighted graph that will help with calculating the approximate path from a source sector to a target sector.</p>
    <p>An edge between two portals exists only if the path between them isn't blocked by an obstacle. The weight of the edge is equal to the amount of
    cells traversed from one portal to the other in a simple Flood Fill algorithm.</p>

    <div class="fig-container" style="text-align: center">
        <figure>
            <img src="img/portalexample1.png" alt="">
            <figcaption>A visualization of the portal graph at the edge between two sectors.</figcaption>
        </figure>
        <figure>
            <img src="img/portalexample2.png" alt="">
            <figcaption>A larger portal graph generated around a few houses. Sectors that contain no obstacles form diamond-shaped graphs.</figcaption>
        </figure>
    </div>

    <p>Each graph node gets assigned its own ID based on the global position of its cell. The graph is stored in a Lua table using the IDs as indexes.</p>

    <!-- HTML generated using hilite.me --><div style="background: #f8f8f8; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%;"><span></span><span style="color: #008000; font-weight: bold">local</span><span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">function</span><span style="color: #BBB"> </span><span style="color: #00F">FloodFill</span>(<span style="color: #19177C">startPos</span>:<span style="color: #BBB"> </span>Vector2,<span style="color: #BBB"> </span><span style="color: #19177C">sectorPos</span>:<span style="color: #BBB"> </span>Vector2)
    <span style="color: #BBB">	</span><span style="color: #19177C">debug</span>.<span style="color: #00F">profilebegin</span>(<span style="color: #BA2121">&quot;Portal Flood Fill&quot;</span>)
    <span style="color: #BBB">	</span><span style="color: #008000; font-weight: bold">local</span><span style="color: #BBB"> </span><span style="color: #19177C">visited</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span>{}
    <span style="color: #BBB">	</span><span style="color: #008000; font-weight: bold">for</span><span style="color: #BBB"> </span><span style="color: #19177C">i</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #666">1</span>,<span style="color: #BBB"> </span><span style="color: #19177C">cellCount</span><span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">do</span>
    <span style="color: #BBB">		</span><span style="color: #19177C">visited</span>[<span style="color: #19177C">i</span>]<span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span>{}
    <span style="color: #BBB">		</span><span style="color: #008000; font-weight: bold">for</span><span style="color: #BBB"> </span><span style="color: #19177C">j</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #666">1</span>,<span style="color: #BBB"> </span><span style="color: #19177C">cellCount</span><span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">do</span>
    <span style="color: #BBB">			</span><span style="color: #19177C">visited</span>[<span style="color: #19177C">i</span>][<span style="color: #19177C">j</span>]<span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">Utils</span>.inf
    <span style="color: #BBB">		</span><span style="color: #008000; font-weight: bold">end</span>
    <span style="color: #BBB">	</span><span style="color: #008000; font-weight: bold">end</span>

    <span style="color: #BBB">	</span><span style="color: #008000; font-weight: bold">local</span><span style="color: #BBB"> </span><span style="color: #19177C">sector</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">sectorGrid</span>[<span style="color: #19177C">sectorPos</span>.X][<span style="color: #19177C">sectorPos</span>.Y]

    <span style="color: #BBB">	</span><span style="color: #008000; font-weight: bold">local</span><span style="color: #BBB"> </span><span style="color: #19177C">q</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">Queue</span>.<span style="color: #00F">new</span>()
    <span style="color: #BBB">	</span><span style="color: #19177C">visited</span>[<span style="color: #19177C">startPos</span>.X][<span style="color: #19177C">startPos</span>.Y]<span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">sector</span>.CostField[<span style="color: #19177C">startPos</span>.X][<span style="color: #19177C">startPos</span>.Y]
    <span style="color: #BBB">	</span><span style="color: #19177C">q</span>:<span style="color: #00F">Enqueue</span>(<span style="color: #19177C">startPos</span>)

    <span style="color: #BBB">	</span><span style="color: #008000; font-weight: bold">while</span><span style="color: #BBB"> </span><span style="color: #A2F; font-weight: bold">not</span><span style="color: #BBB"> </span><span style="color: #19177C">q</span>:<span style="color: #00F">IsEmpty</span>()<span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">do</span>
    <span style="color: #BBB">		</span><span style="color: #008000; font-weight: bold">local</span><span style="color: #BBB"> </span><span style="color: #19177C">curr</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">q</span>:<span style="color: #00F">Dequeue</span>()

    <span style="color: #BBB">		</span><span style="color: #008000; font-weight: bold">for</span><span style="color: #BBB"> </span><span style="color: #19177C">_</span>,<span style="color: #BBB"> </span><span style="color: #19177C">dir</span><span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">in</span><span style="color: #BBB"> </span><span style="color: #19177C">dirs</span><span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">do</span>
    <span style="color: #BBB">			</span><span style="color: #008000; font-weight: bold">local</span><span style="color: #BBB"> </span><span style="color: #008000">next</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">curr</span><span style="color: #BBB"> </span><span style="color: #666">+</span><span style="color: #BBB"> </span><span style="color: #19177C">dir</span>

    <span style="color: #BBB">			</span><span style="color: #008000; font-weight: bold">if</span><span style="color: #BBB"> </span><span style="color: #A2F; font-weight: bold">not</span><span style="color: #BBB"> </span><span style="color: #19177C">Utils</span>.<span style="color: #00F">IsValidCellPos</span>(<span style="color: #008000">next</span>)<span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">then</span>
    <span style="color: #BBB">				</span><span style="color: #19177C">continue</span>
    <span style="color: #BBB">			</span><span style="color: #008000; font-weight: bold">end</span>
    <span style="color: #BBB">			</span>
    <span style="color: #BBB">			</span><span style="color: #008000; font-weight: bold">if</span><span style="color: #BBB"> </span><span style="color: #19177C">sector</span>.CostField[<span style="color: #008000">next</span>.<span style="color: #19177C">X</span>][<span style="color: #008000">next</span>.<span style="color: #19177C">Y</span>]<span style="color: #BBB"> </span><span style="color: #666">==</span><span style="color: #BBB"> </span><span style="color: #19177C">SectorInfo</span>.MaxCost<span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">then</span>
    <span style="color: #BBB">				</span><span style="color: #19177C">sector</span>.CellRegion[<span style="color: #008000">next</span>.<span style="color: #19177C">X</span>][<span style="color: #008000">next</span>.<span style="color: #19177C">Y</span>]<span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">sector</span>.CellRegion[<span style="color: #19177C">startPos</span>.X][<span style="color: #19177C">startPos</span>.Y]
    <span style="color: #BBB">				</span><span style="color: #19177C">continue</span>
    <span style="color: #BBB">			</span><span style="color: #008000; font-weight: bold">end</span>

    <span style="color: #BBB">			</span><span style="color: #008000; font-weight: bold">local</span><span style="color: #BBB"> </span><span style="color: #19177C">cost</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">visited</span>[<span style="color: #19177C">curr</span>.X][<span style="color: #19177C">curr</span>.Y]<span style="color: #BBB"> </span><span style="color: #666">+</span><span style="color: #BBB"> </span><span style="color: #19177C">sector</span>.CostField[<span style="color: #008000">next</span>.<span style="color: #19177C">X</span>][<span style="color: #008000">next</span>.<span style="color: #19177C">Y</span>]
    <span style="color: #BBB">			</span><span style="color: #008000; font-weight: bold">if</span><span style="color: #BBB"> </span><span style="color: #19177C">visited</span>[<span style="color: #008000">next</span>.<span style="color: #19177C">X</span>][<span style="color: #008000">next</span>.<span style="color: #19177C">Y</span>]<span style="color: #BBB"> </span><span style="color: #666">&gt;</span><span style="color: #BBB"> </span><span style="color: #19177C">cost</span><span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">then</span>
    <span style="color: #BBB">				</span><span style="color: #19177C">visited</span>[<span style="color: #008000">next</span>.<span style="color: #19177C">X</span>][<span style="color: #008000">next</span>.<span style="color: #19177C">Y</span>]<span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">cost</span>
    <span style="color: #BBB">				</span><span style="color: #19177C">sector</span>.CellRegion[<span style="color: #008000">next</span>.<span style="color: #19177C">X</span>][<span style="color: #008000">next</span>.<span style="color: #19177C">Y</span>]<span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">sector</span>.CellRegion[<span style="color: #19177C">startPos</span>.X][<span style="color: #19177C">startPos</span>.Y]
    <span style="color: #BBB">				</span><span style="color: #19177C">q</span>:<span style="color: #00F">Enqueue</span>(<span style="color: #008000">next</span>)
    <span style="color: #BBB">			</span><span style="color: #008000; font-weight: bold">end</span>
    <span style="color: #BBB">		</span><span style="color: #008000; font-weight: bold">end</span>
    <span style="color: #BBB">	</span><span style="color: #008000; font-weight: bold">end</span>

    <span style="color: #BBB">	</span><span style="color: #19177C">debug</span>.<span style="color: #00F">profileend</span>()
    <span style="color: #BBB">	</span><span style="color: #008000; font-weight: bold">return</span><span style="color: #BBB"> </span><span style="color: #19177C">visited</span>
    <span style="color: #008000; font-weight: bold">end</span>
    </pre></div>

    <!-- HTML generated using hilite.me --><div style="background: #f8f8f8; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%;"><span></span><span style="color: #008000; font-weight: bold">local</span><span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">function</span><span style="color: #BBB"> </span><span style="color: #00F">ConnectPortalsFlood</span>(<span style="color: #19177C">sectorPos</span>:<span style="color: #BBB"> </span>Vector2)
    <span style="color: #BBB">	</span><span style="color: #19177C">debug</span>.<span style="color: #00F">profilebegin</span>(<span style="color: #BA2121">&quot;Portal Graph Generation&quot;</span>)
    <span style="color: #BBB">	</span><span style="color: #008000; font-weight: bold">local</span><span style="color: #BBB"> </span><span style="color: #19177C">sector</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">sectorGrid</span>[<span style="color: #19177C">sectorPos</span>.X][<span style="color: #19177C">sectorPos</span>.Y]
    <span style="color: #BBB">	</span><span style="color: #008000; font-weight: bold">local</span><span style="color: #BBB"> </span><span style="color: #19177C">chunk</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">debugChunk</span>[<span style="color: #19177C">sectorPos</span>.X][<span style="color: #19177C">sectorPos</span>.Y]

    <span style="color: #BBB">	</span><span style="color: #3D7B7B; font-style: italic">--clear this sector&#39;s graph</span>
    <span style="color: #BBB">	</span><span style="color: #008000; font-weight: bold">for</span><span style="color: #BBB"> </span><span style="color: #19177C">side</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #666">0</span>,<span style="color: #BBB"> </span><span style="color: #666">3</span><span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">do</span>
    <span style="color: #BBB">		</span><span style="color: #008000; font-weight: bold">for</span><span style="color: #BBB"> </span><span style="color: #19177C">_</span>,<span style="color: #BBB"> </span><span style="color: #19177C">portal</span><span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">in</span><span style="color: #BBB"> </span><span style="color: #19177C">sector</span>.Portals[<span style="color: #19177C">side</span>]<span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">do</span>
    <span style="color: #BBB">			</span><span style="color: #008000; font-weight: bold">local</span><span style="color: #BBB"> </span><span style="color: #19177C">nodeId</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">Utils</span>.<span style="color: #00F">ConvertPortalPosToNumber</span>(<span style="color: #19177C">portal</span>,<span style="color: #BBB"> </span><span style="color: #19177C">sectorPos</span>,<span style="color: #BBB"> </span><span style="color: #19177C">side</span>)
    <span style="color: #BBB">			</span><span style="color: #008000; font-weight: bold">if</span><span style="color: #BBB"> </span><span style="color: #19177C">portalGraph</span>[<span style="color: #19177C">nodeId</span>]<span style="color: #BBB"> </span><span style="color: #666">==</span><span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">nil</span><span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">then</span>
    <span style="color: #BBB">				</span><span style="color: #19177C">portalGraph</span>[<span style="color: #19177C">nodeId</span>]<span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span>{}
    <span style="color: #BBB">			</span><span style="color: #008000; font-weight: bold">else</span>
    <span style="color: #BBB">				</span><span style="color: #19177C">table</span>.<span style="color: #00F">clear</span>(<span style="color: #19177C">portalGraph</span>[<span style="color: #19177C">nodeId</span>])
    <span style="color: #BBB">			</span><span style="color: #008000; font-weight: bold">end</span>
    <span style="color: #BBB">		</span><span style="color: #008000; font-weight: bold">end</span>
    <span style="color: #BBB">	</span><span style="color: #008000; font-weight: bold">end</span>

    <span style="color: #BBB">	</span><span style="color: #19177C">table</span>.<span style="color: #00F">clear</span>(<span style="color: #19177C">sector</span>.CellRegion)
    <span style="color: #BBB">	</span><span style="color: #008000; font-weight: bold">for</span><span style="color: #BBB"> </span><span style="color: #19177C">i</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #666">1</span>,<span style="color: #BBB"> </span><span style="color: #19177C">cellCount</span><span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">do</span>
    <span style="color: #BBB">		</span><span style="color: #19177C">sector</span>.CellRegion[<span style="color: #19177C">i</span>]<span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span>{}
    <span style="color: #BBB">		</span><span style="color: #008000; font-weight: bold">for</span><span style="color: #BBB"> </span><span style="color: #19177C">j</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #666">1</span>,<span style="color: #BBB"> </span><span style="color: #19177C">cellCount</span><span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">do</span>
    <span style="color: #BBB">			</span><span style="color: #19177C">sector</span>.CellRegion[<span style="color: #19177C">i</span>][<span style="color: #19177C">j</span>]<span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #666">0</span>
    <span style="color: #BBB">		</span><span style="color: #008000; font-weight: bold">end</span>
    <span style="color: #BBB">	</span><span style="color: #008000; font-weight: bold">end</span>
    <span style="color: #BBB">	</span><span style="color: #008000; font-weight: bold">local</span><span style="color: #BBB"> </span><span style="color: #19177C">region</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #666">0</span>

    <span style="color: #BBB">	</span><span style="color: #008000; font-weight: bold">for</span><span style="color: #BBB"> </span><span style="color: #19177C">sideSource</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #666">0</span>,<span style="color: #BBB"> </span><span style="color: #666">3</span><span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">do</span>
    <span style="color: #BBB">		</span><span style="color: #008000; font-weight: bold">local</span><span style="color: #BBB"> </span><span style="color: #19177C">nodeIds</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span>{}
    <span style="color: #BBB">		</span><span style="color: #3D7B7B; font-style: italic">--internal edges</span>
    <span style="color: #BBB">		</span><span style="color: #008000; font-weight: bold">for</span><span style="color: #BBB"> </span><span style="color: #19177C">_</span>,<span style="color: #BBB"> </span><span style="color: #19177C">portalSource</span><span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">in</span><span style="color: #BBB"> </span><span style="color: #19177C">sector</span>.Portals[<span style="color: #19177C">sideSource</span>]<span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">do</span><span style="color: #BBB">	</span>
    <span style="color: #BBB">			</span><span style="color: #3D7B7B; font-style: italic">--divides cells into regions based on accessibility; useful for establishing correct pathing between sectors</span>
    <span style="color: #BBB">			</span><span style="color: #008000; font-weight: bold">if</span><span style="color: #BBB"> </span><span style="color: #19177C">sector</span>.CellRegion[<span style="color: #19177C">portalSource</span>.X][<span style="color: #19177C">portalSource</span>.Y]<span style="color: #BBB"> </span><span style="color: #666">==</span><span style="color: #BBB"> </span><span style="color: #666">0</span><span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">then</span>
    <span style="color: #BBB">				</span><span style="color: #19177C">region</span><span style="color: #BBB"> </span><span style="color: #666">+=</span><span style="color: #BBB"> </span><span style="color: #666">1</span>
    <span style="color: #BBB">				</span><span style="color: #19177C">sector</span>.CellRegion[<span style="color: #19177C">portalSource</span>.X][<span style="color: #19177C">portalSource</span>.Y]<span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">region</span>
    <span style="color: #BBB">			</span><span style="color: #008000; font-weight: bold">end</span>
    <span style="color: #BBB">			</span><span style="color: #008000; font-weight: bold">local</span><span style="color: #BBB"> </span><span style="color: #19177C">dists</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #00F">FloodFill</span>(<span style="color: #19177C">portalSource</span>,<span style="color: #BBB"> </span><span style="color: #19177C">sectorPos</span>)

    <span style="color: #BBB">			</span><span style="color: #3D7B7B; font-style: italic">--assigns a unique id to each portal in the graph adjacency list</span>
    <span style="color: #BBB">			</span><span style="color: #008000; font-weight: bold">local</span><span style="color: #BBB"> </span><span style="color: #19177C">nodeId</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">Utils</span>.<span style="color: #00F">ConvertPortalPosToNumber</span>(<span style="color: #19177C">portalSource</span>,<span style="color: #BBB"> </span><span style="color: #19177C">sectorPos</span>,<span style="color: #BBB"> </span><span style="color: #19177C">sideSource</span>)
    <span style="color: #BBB">			</span><span style="color: #008000">table.insert</span>(<span style="color: #19177C">nodeIds</span>,<span style="color: #BBB"> </span><span style="color: #19177C">nodeId</span>)<span style="color: #BBB"> </span><span style="color: #3D7B7B; font-style: italic">--no need to recalculate node ids for this side</span>
    <span style="color: #BBB">			</span><span style="color: #008000; font-weight: bold">local</span><span style="color: #BBB"> </span><span style="color: #19177C">portalInfo</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span>{
    <span style="color: #BBB">				</span><span style="color: #19177C">SectorPos</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">sectorPos</span>,
    <span style="color: #BBB">				</span><span style="color: #19177C">CellPos</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">portalSource</span>,
    <span style="color: #BBB">				</span><span style="color: #19177C">Side</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">sideSource</span>,
    <span style="color: #BBB">				</span><span style="color: #19177C">Region</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">sector</span>.CellRegion[<span style="color: #19177C">portalSource</span>.X][<span style="color: #19177C">portalSource</span>.Y],
    <span style="color: #BBB">				</span><span style="color: #19177C">Index</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">sector</span>:<span style="color: #00F">GetSideIndexFromCellPos</span>(<span style="color: #19177C">portalSource</span>,<span style="color: #BBB"> </span><span style="color: #19177C">sideSource</span>)
    <span style="color: #BBB">			</span>}
    <span style="color: #BBB">			</span><span style="color: #19177C">portalFromId</span>[<span style="color: #19177C">nodeId</span>]<span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">portalInfo</span>

    <span style="color: #BBB">			</span><span style="color: #00F">DebugInsertProperties</span>(<span style="color: #19177C">chunk</span>.Display[<span style="color: #19177C">DebugEnums</span>.DebugDisplayMode.Cost],<span style="color: #BBB"> </span>{
    <span style="color: #BBB">				</span><span style="color: #19177C">Type</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">DebugEnums</span>.DebugObject.Text,
    <span style="color: #BBB">				</span><span style="color: #19177C">SectorPosition</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">sectorPos</span>,
    <span style="color: #BBB">				</span><span style="color: #19177C">Position</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #00F">DebugGetCellCenter</span>(<span style="color: #19177C">portalSource</span>,<span style="color: #BBB"> </span><span style="color: #19177C">sectorPos</span>)<span style="color: #BBB"> </span><span style="color: #666">+</span><span style="color: #BBB"> </span><span style="color: #19177C">Vector3</span>.yAxis<span style="color: #BBB"> </span><span style="color: #666">*</span><span style="color: #BBB"> </span><span style="color: #19177C">sector</span>.Heightmap[<span style="color: #19177C">portalSource</span>.X][<span style="color: #19177C">portalSource</span>.Y],
    <span style="color: #BBB">				</span><span style="color: #19177C">Text</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">nodeId</span>,
    <span style="color: #BBB">				</span><span style="color: #19177C">Color</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">Color3</span>.<span style="color: #00F">new</span>(<span style="color: #666">1</span>,<span style="color: #BBB"> </span><span style="color: #666">0</span>,<span style="color: #BBB"> </span><span style="color: #666">0</span>),
    <span style="color: #BBB">				</span><span style="color: #19177C">FontSize</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #666">12</span>,
    <span style="color: #BBB">			</span>})

    <span style="color: #BBB">			</span><span style="color: #008000; font-weight: bold">for</span><span style="color: #BBB"> </span><span style="color: #19177C">sideTarget</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #666">0</span>,<span style="color: #BBB"> </span><span style="color: #666">3</span><span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">do</span>
    <span style="color: #BBB">				</span><span style="color: #008000; font-weight: bold">for</span><span style="color: #BBB"> </span><span style="color: #19177C">_</span>,<span style="color: #BBB"> </span><span style="color: #19177C">portalTarget</span><span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">in</span><span style="color: #BBB"> </span><span style="color: #19177C">sector</span>.Portals[<span style="color: #19177C">sideTarget</span>]<span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">do</span>
    <span style="color: #BBB">					</span><span style="color: #008000; font-weight: bold">if</span><span style="color: #BBB"> </span>(<span style="color: #19177C">portalSource</span><span style="color: #BBB"> </span><span style="color: #666">==</span><span style="color: #BBB"> </span><span style="color: #19177C">portalTarget</span><span style="color: #BBB"> </span><span style="color: #A2F; font-weight: bold">and</span><span style="color: #BBB"> </span><span style="color: #19177C">sideSource</span><span style="color: #BBB"> </span><span style="color: #666">==</span><span style="color: #BBB"> </span><span style="color: #19177C">sideTarget</span>)<span style="color: #BBB"> </span><span style="color: #A2F; font-weight: bold">or</span><span style="color: #BBB"> </span><span style="color: #19177C">dists</span>[<span style="color: #19177C">portalTarget</span>.X][<span style="color: #19177C">portalTarget</span>.Y]<span style="color: #BBB"> </span><span style="color: #666">==</span><span style="color: #BBB"> </span><span style="color: #19177C">Utils</span>.inf<span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">then</span>
    <span style="color: #BBB">						</span><span style="color: #19177C">continue</span>
    <span style="color: #BBB">					</span><span style="color: #008000; font-weight: bold">end</span>

    <span style="color: #BBB">					</span><span style="color: #008000; font-weight: bold">local</span><span style="color: #BBB"> </span><span style="color: #19177C">edge</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span>{
    <span style="color: #BBB">						</span><span style="color: #19177C">TargetSectorPos</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">sectorPos</span>,
    <span style="color: #BBB">						</span><span style="color: #19177C">Target</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">portalTarget</span>,
    <span style="color: #BBB">						</span><span style="color: #19177C">TargetSide</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">sideTarget</span>,
    <span style="color: #BBB">						</span><span style="color: #19177C">Distance</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">dists</span>[<span style="color: #19177C">portalTarget</span>.X][<span style="color: #19177C">portalTarget</span>.Y]
    <span style="color: #BBB">					</span>}
    <span style="color: #BBB">					</span><span style="color: #008000">table.insert</span>(<span style="color: #19177C">portalGraph</span>[<span style="color: #19177C">nodeId</span>],<span style="color: #BBB"> </span><span style="color: #19177C">edge</span>)

    <span style="color: #BBB">					</span><span style="color: #00F">DebugInsertProperties</span>(<span style="color: #19177C">chunk</span>.Display[<span style="color: #19177C">DebugEnums</span>.DebugDisplayMode.Cost],<span style="color: #BBB"> </span>{
    <span style="color: #BBB">						</span><span style="color: #19177C">Type</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">DebugEnums</span>.DebugObject.Line,
    <span style="color: #BBB">						</span><span style="color: #19177C">SectorPosition</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">sectorPos</span>,
    <span style="color: #BBB">						</span><span style="color: #19177C">Point1</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #00F">DebugGetCellCenter</span>(<span style="color: #19177C">portalSource</span>,<span style="color: #BBB"> </span><span style="color: #19177C">sectorPos</span>)<span style="color: #BBB"> </span><span style="color: #666">+</span><span style="color: #BBB"> </span><span style="color: #19177C">Vector3</span>.yAxis<span style="color: #BBB"> </span><span style="color: #666">*</span><span style="color: #BBB"> </span><span style="color: #19177C">sector</span>.Heightmap[<span style="color: #19177C">portalSource</span>.X][<span style="color: #19177C">portalSource</span>.Y],
    <span style="color: #BBB">						</span><span style="color: #19177C">Point2</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #00F">DebugGetCellCenter</span>(<span style="color: #19177C">portalTarget</span>,<span style="color: #BBB"> </span><span style="color: #19177C">sectorPos</span>)<span style="color: #BBB"> </span><span style="color: #666">+</span><span style="color: #BBB"> </span><span style="color: #19177C">Vector3</span>.yAxis<span style="color: #BBB"> </span><span style="color: #666">*</span><span style="color: #BBB"> </span><span style="color: #19177C">sector</span>.Heightmap[<span style="color: #19177C">portalTarget</span>.X][<span style="color: #19177C">portalTarget</span>.Y],
    <span style="color: #BBB">						</span><span style="color: #19177C">Color</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">DebugPortalColor</span><span style="color: #BBB">	</span>
    <span style="color: #BBB">					</span>})
    <span style="color: #BBB">				</span><span style="color: #008000; font-weight: bold">end</span>
    <span style="color: #BBB">			</span><span style="color: #008000; font-weight: bold">end</span>

    <span style="color: #BBB">			</span><span style="color: #19177C">table</span>.<span style="color: #00F">clear</span>(<span style="color: #19177C">dists</span>)
    <span style="color: #BBB">		</span><span style="color: #008000; font-weight: bold">end</span>

    <span style="color: #BBB">		</span><span style="color: #3D7B7B; font-style: italic">--external edges</span>
    <span style="color: #BBB">		</span><span style="color: #008000; font-weight: bold">local</span><span style="color: #BBB"> </span><span style="color: #19177C">sideAdj</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span>(<span style="color: #19177C">sideSource</span><span style="color: #BBB"> </span><span style="color: #666">+</span><span style="color: #BBB"> </span><span style="color: #666">2</span>)<span style="color: #BBB"> </span><span style="color: #666">%</span><span style="color: #BBB"> </span><span style="color: #666">4</span>
    <span style="color: #BBB">		</span><span style="color: #008000; font-weight: bold">local</span><span style="color: #BBB"> </span><span style="color: #19177C">sectorAdjPos</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">sectorPos</span><span style="color: #BBB"> </span><span style="color: #666">+</span><span style="color: #BBB"> </span><span style="color: #19177C">dirs</span>[<span style="color: #19177C">sideSource</span><span style="color: #BBB"> </span><span style="color: #666">+</span><span style="color: #BBB"> </span><span style="color: #666">1</span>]
    <span style="color: #BBB">		</span><span style="color: #008000; font-weight: bold">if</span><span style="color: #BBB"> </span><span style="color: #A2F; font-weight: bold">not</span><span style="color: #BBB"> </span><span style="color: #19177C">Utils</span>.<span style="color: #00F">IsValidSectorPos</span>(<span style="color: #19177C">sectorAdjPos</span>)<span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">then</span>
    <span style="color: #BBB">			</span><span style="color: #19177C">continue</span>
    <span style="color: #BBB">		</span><span style="color: #008000; font-weight: bold">end</span>

    <span style="color: #BBB">		</span><span style="color: #008000; font-weight: bold">local</span><span style="color: #BBB"> </span><span style="color: #19177C">sectorAdj</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">sectorGrid</span>[<span style="color: #19177C">sectorAdjPos</span>.X][<span style="color: #19177C">sectorAdjPos</span>.Y]

    <span style="color: #BBB">		</span><span style="color: #008000; font-weight: bold">for</span><span style="color: #BBB"> </span><span style="color: #19177C">idx</span>,<span style="color: #BBB"> </span><span style="color: #19177C">portalSource</span><span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">in</span><span style="color: #BBB"> </span><span style="color: #19177C">sector</span>.Portals[<span style="color: #19177C">sideSource</span>]<span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">do</span>
    <span style="color: #BBB">			</span><span style="color: #008000; font-weight: bold">local</span><span style="color: #BBB"> </span><span style="color: #19177C">portalTarget</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">sectorAdj</span>.Portals[<span style="color: #19177C">sideAdj</span>][<span style="color: #19177C">idx</span>]

    <span style="color: #BBB">			</span><span style="color: #008000; font-weight: bold">local</span><span style="color: #BBB"> </span><span style="color: #19177C">edge</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span>{
    <span style="color: #BBB">				</span><span style="color: #19177C">TargetSectorPos</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">sectorAdjPos</span>,
    <span style="color: #BBB">				</span><span style="color: #19177C">Target</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">portalTarget</span>,
    <span style="color: #BBB">				</span><span style="color: #19177C">TargetSide</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">sideAdj</span>,
    <span style="color: #BBB">				</span><span style="color: #19177C">Distance</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #666">1</span>
    <span style="color: #BBB">			</span>}
    <span style="color: #BBB">			</span><span style="color: #008000">table.insert</span>(<span style="color: #19177C">portalGraph</span>[<span style="color: #19177C">nodeIds</span>[<span style="color: #19177C">idx</span>]],<span style="color: #BBB"> </span><span style="color: #19177C">edge</span>)

    <span style="color: #BBB">			</span><span style="color: #00F">DebugInsertProperties</span>(<span style="color: #19177C">chunk</span>.Display[<span style="color: #19177C">DebugEnums</span>.DebugDisplayMode.Cost],<span style="color: #BBB"> </span>{
    <span style="color: #BBB">				</span><span style="color: #19177C">Type</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">DebugEnums</span>.DebugObject.Line,
    <span style="color: #BBB">				</span><span style="color: #19177C">SectorPosition</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">sectorPos</span>,
    <span style="color: #BBB">				</span><span style="color: #19177C">Point1</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #00F">DebugGetCellCenter</span>(<span style="color: #19177C">portalSource</span>,<span style="color: #BBB"> </span><span style="color: #19177C">sectorPos</span>)<span style="color: #BBB"> </span><span style="color: #666">+</span><span style="color: #BBB"> </span><span style="color: #19177C">Vector3</span>.yAxis<span style="color: #BBB"> </span><span style="color: #666">*</span><span style="color: #BBB"> </span><span style="color: #19177C">sector</span>.Heightmap[<span style="color: #19177C">portalSource</span>.X][<span style="color: #19177C">portalSource</span>.Y],
    <span style="color: #BBB">				</span><span style="color: #19177C">Point2</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #00F">DebugGetCellCenter</span>(<span style="color: #19177C">portalTarget</span>,<span style="color: #BBB"> </span><span style="color: #19177C">sectorAdjPos</span>)<span style="color: #BBB"> </span><span style="color: #666">+</span><span style="color: #BBB"> </span><span style="color: #19177C">Vector3</span>.yAxis<span style="color: #BBB"> </span><span style="color: #666">*</span><span style="color: #BBB"> </span><span style="color: #19177C">sectorAdj</span>.Heightmap[<span style="color: #19177C">portalTarget</span>.X][<span style="color: #19177C">portalTarget</span>.Y],
    <span style="color: #BBB">				</span><span style="color: #19177C">Color</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">DebugPortalColor</span><span style="color: #BBB">	</span>
    <span style="color: #BBB">			</span>})
    <span style="color: #BBB">		</span><span style="color: #008000; font-weight: bold">end</span>
    <span style="color: #BBB">	</span><span style="color: #008000; font-weight: bold">end</span>
    <span style="color: #008000; font-weight: bold">end</span>
    </pre></div>
</div>

<div class="infobox" data-title="Approximate Path Calculation">
    <h1>Approximate Path Calculation</h1>
    <p>The algorithm traverses the previously generated graph using A* to establish the general path in which an agent should go.
    This is done to calculate flow fields only for necessary regions of the map through which the agent is guaranteed to travel.</p>
    <div class="fig-container" style="text-align: center">
        <figure>
            <img src="img/pathexample1.png" alt="" style="max-height: 600px">
            <figcaption>The full portal graph. It can get a bit messy inside certain sectors.</figcaption>
        </figure>
        <figure>
            <img src="img/pathexample2.png" alt="" style="max-height: 600px">
            <figcaption>The approximated path between point A (green) and point B (red) visualized using the integration field.</figcaption>
        </figure>
    </div>

    <p>The heuristic for my A* implementation is the distance between the source and the target.</p>

    <!-- HTML generated using hilite.me --><div style="background: #f8f8f8; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%;"><span></span><span style="color: #008000; font-weight: bold">local</span><span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">function</span><span style="color: #BBB"> </span><span style="color: #00F">GetPortalPath</span>(<span style="color: #19177C">sourcePos</span>:<span style="color: #BBB"> </span>Vector3,<span style="color: #BBB"> </span><span style="color: #19177C">targetPos</span>:<span style="color: #BBB"> </span>Vector3)<span style="color: #BBB">	</span>
    <span style="color: #BBB">	</span><span style="color: #008000; font-weight: bold">local</span><span style="color: #BBB"> </span><span style="color: #19177C">t</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #008000">os.clock</span>()
    <span style="color: #BBB">	</span><span style="color: #19177C">debug</span>.<span style="color: #00F">profilebegin</span>(<span style="color: #BA2121">&quot;Portal Path Calculation&quot;</span>)
    <span style="color: #BBB">	</span>
    <span style="color: #BBB">	</span><span style="color: #008000; font-weight: bold">local</span><span style="color: #BBB"> </span><span style="color: #19177C">sectorSourcePos</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">Utils</span>.<span style="color: #00F">ConvertToSectorGridPos</span>(<span style="color: #19177C">sourcePos</span>)
    <span style="color: #BBB">	</span><span style="color: #008000; font-weight: bold">local</span><span style="color: #BBB"> </span><span style="color: #19177C">localSourcePos</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">Utils</span>.<span style="color: #00F">ConvertToLocalCellPos</span>(<span style="color: #19177C">sourcePos</span>)
    <span style="color: #BBB">	</span><span style="color: #008000; font-weight: bold">local</span><span style="color: #BBB"> </span><span style="color: #19177C">sectorTargetPos</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">Utils</span>.<span style="color: #00F">ConvertToSectorGridPos</span>(<span style="color: #19177C">targetPos</span>)
    <span style="color: #BBB">	</span><span style="color: #008000; font-weight: bold">local</span><span style="color: #BBB"> </span><span style="color: #19177C">globalTargetPos</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">Utils</span>.<span style="color: #00F">ConvertToGlobalCellPos</span>(<span style="color: #19177C">targetPos</span>)
    <span style="color: #BBB">	</span><span style="color: #008000; font-weight: bold">local</span><span style="color: #BBB"> </span><span style="color: #19177C">localTargetPos</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">Utils</span>.<span style="color: #00F">ConvertToLocalCellPos</span>(<span style="color: #19177C">targetPos</span>)

    <span style="color: #BBB">	</span><span style="color: #008000; font-weight: bold">local</span><span style="color: #BBB"> </span><span style="color: #19177C">sectorSource</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">sectorGrid</span>[<span style="color: #19177C">sectorSourcePos</span>.X][<span style="color: #19177C">sectorSourcePos</span>.Y]
    <span style="color: #BBB">	</span><span style="color: #008000; font-weight: bold">local</span><span style="color: #BBB"> </span><span style="color: #19177C">dist</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span>{}
    <span style="color: #BBB">	</span><span style="color: #008000; font-weight: bold">local</span><span style="color: #BBB"> </span><span style="color: #19177C">parentPortalId</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span>{}

    <span style="color: #BBB">	</span><span style="color: #008000; font-weight: bold">local</span><span style="color: #BBB"> </span><span style="color: #19177C">pathFound</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">false</span>
    <span style="color: #BBB">	</span><span style="color: #008000; font-weight: bold">local</span><span style="color: #BBB"> </span><span style="color: #19177C">goalId</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">nil</span>
    <span style="color: #BBB">	</span><span style="color: #008000; font-weight: bold">local</span><span style="color: #BBB"> </span><span style="color: #19177C">pq</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">PriorityQueue</span>.<span style="color: #00F">new</span>()
    <span style="color: #BBB">	</span><span style="color: #008000; font-weight: bold">for</span><span style="color: #BBB"> </span><span style="color: #19177C">sideSource</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #666">0</span>,<span style="color: #BBB"> </span><span style="color: #666">3</span><span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">do</span>
    <span style="color: #BBB">		</span><span style="color: #008000; font-weight: bold">for</span><span style="color: #BBB"> </span><span style="color: #19177C">_</span>,<span style="color: #BBB"> </span><span style="color: #19177C">portal</span><span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">in</span><span style="color: #BBB"> </span><span style="color: #19177C">sectorSource</span>.Portals[<span style="color: #19177C">sideSource</span>]<span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">do</span>
    <span style="color: #BBB">			</span><span style="color: #008000; font-weight: bold">if</span><span style="color: #BBB"> </span><span style="color: #19177C">sectorSource</span>.CellRegion[<span style="color: #19177C">portal</span>.X][<span style="color: #19177C">portal</span>.Y]<span style="color: #BBB"> </span><span style="color: #666">~=</span><span style="color: #BBB"> </span><span style="color: #19177C">sectorSource</span>.CellRegion[<span style="color: #19177C">localSourcePos</span>.X][<span style="color: #19177C">localSourcePos</span>.Y]<span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">then</span>
    <span style="color: #BBB">				</span><span style="color: #19177C">continue</span>
    <span style="color: #BBB">			</span><span style="color: #008000; font-weight: bold">end</span>
    <span style="color: #BBB">			</span><span style="color: #008000; font-weight: bold">local</span><span style="color: #BBB"> </span><span style="color: #19177C">nodeId</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">Utils</span>.<span style="color: #00F">ConvertPortalPosToNumber</span>(<span style="color: #19177C">portal</span>,<span style="color: #BBB"> </span><span style="color: #19177C">sectorSourcePos</span>,<span style="color: #BBB"> </span><span style="color: #19177C">sideSource</span>)
    <span style="color: #BBB">			</span><span style="color: #19177C">dist</span>[<span style="color: #19177C">nodeId</span>]<span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #666">0</span>
    <span style="color: #BBB">			</span><span style="color: #19177C">pq</span>:<span style="color: #00F">Enqueue</span>(<span style="color: #19177C">nodeId</span>,<span style="color: #BBB"> </span><span style="color: #666">0</span>)<span style="color: #3D7B7B; font-style: italic">---(Utils.GetGlobalCellPos(portal, sectorSourcePos) - globalTargetPos).Magnitude)</span>
    <span style="color: #BBB">		</span><span style="color: #008000; font-weight: bold">end</span>
    <span style="color: #BBB">	</span><span style="color: #008000; font-weight: bold">end</span>

    <span style="color: #BBB">	</span><span style="color: #008000; font-weight: bold">while</span><span style="color: #BBB"> </span><span style="color: #A2F; font-weight: bold">not</span><span style="color: #BBB"> </span><span style="color: #19177C">pq</span>:<span style="color: #00F">IsEmpty</span>()<span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">do</span>
    <span style="color: #BBB">		</span><span style="color: #008000; font-weight: bold">local</span><span style="color: #BBB"> </span><span style="color: #19177C">currId</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">pq</span>:<span style="color: #00F">Dequeue</span>()

    <span style="color: #BBB">		</span><span style="color: #008000; font-weight: bold">if</span><span style="color: #BBB"> </span><span style="color: #19177C">portalFromId</span>[<span style="color: #19177C">currId</span>].<span style="color: #19177C">SectorPos</span><span style="color: #BBB"> </span><span style="color: #666">==</span><span style="color: #BBB"> </span><span style="color: #19177C">sectorTargetPos</span><span style="color: #BBB"> </span><span style="color: #A2F; font-weight: bold">and</span><span style="color: #BBB"> </span><span style="color: #19177C">portalFromId</span>[<span style="color: #19177C">currId</span>].<span style="color: #19177C">Region</span><span style="color: #BBB"> </span><span style="color: #666">==</span><span style="color: #BBB"> </span><span style="color: #19177C">sectorGrid</span>[<span style="color: #19177C">sectorTargetPos</span>.X][<span style="color: #19177C">sectorTargetPos</span>.Y].<span style="color: #19177C">CellRegion</span>[<span style="color: #19177C">localTargetPos</span>.X][<span style="color: #19177C">localTargetPos</span>.Y]<span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">then</span>
    <span style="color: #BBB">			</span><span style="color: #19177C">pathFound</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">true</span>
    <span style="color: #BBB">			</span><span style="color: #19177C">goalId</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">currId</span>
    <span style="color: #BBB">			</span><span style="color: #008000; font-weight: bold">break</span>
    <span style="color: #BBB">		</span><span style="color: #008000; font-weight: bold">end</span>

    <span style="color: #BBB">		</span><span style="color: #008000; font-weight: bold">for</span><span style="color: #BBB"> </span><span style="color: #19177C">_</span>,<span style="color: #BBB"> </span><span style="color: #19177C">adj</span><span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">in</span><span style="color: #BBB"> </span><span style="color: #19177C">portalGraph</span>[<span style="color: #19177C">currId</span>]<span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">do</span>
    <span style="color: #BBB">			</span><span style="color: #008000; font-weight: bold">local</span><span style="color: #BBB"> </span><span style="color: #19177C">adjNodeId</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">Utils</span>.<span style="color: #00F">ConvertPortalPosToNumber</span>(<span style="color: #19177C">adj</span>.Target,<span style="color: #BBB"> </span><span style="color: #19177C">adj</span>.TargetSectorPos,<span style="color: #BBB"> </span><span style="color: #19177C">adj</span>.TargetSide)
    <span style="color: #BBB">			</span><span style="color: #008000; font-weight: bold">local</span><span style="color: #BBB"> </span><span style="color: #19177C">h</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span>(<span style="color: #19177C">Utils</span>.<span style="color: #00F">GetGlobalCellPos</span>(<span style="color: #19177C">adj</span>.Target,<span style="color: #BBB"> </span><span style="color: #19177C">adj</span>.TargetSectorPos)<span style="color: #BBB"> </span><span style="color: #666">-</span><span style="color: #BBB"> </span><span style="color: #19177C">globalTargetPos</span>).<span style="color: #19177C">Magnitude</span>
    <span style="color: #BBB">			</span><span style="color: #008000; font-weight: bold">local</span><span style="color: #BBB"> </span><span style="color: #19177C">cost</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">dist</span>[<span style="color: #19177C">currId</span>]<span style="color: #BBB"> </span><span style="color: #666">+</span><span style="color: #BBB"> </span><span style="color: #19177C">adj</span>.Distance
    <span style="color: #BBB">			</span><span style="color: #008000; font-weight: bold">if</span><span style="color: #BBB"> </span><span style="color: #19177C">dist</span>[<span style="color: #19177C">adjNodeId</span>]<span style="color: #BBB"> </span><span style="color: #666">==</span><span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">nil</span><span style="color: #BBB"> </span><span style="color: #A2F; font-weight: bold">or</span><span style="color: #BBB"> </span><span style="color: #19177C">dist</span>[<span style="color: #19177C">adjNodeId</span>]<span style="color: #BBB"> </span><span style="color: #666">&gt;</span><span style="color: #BBB"> </span><span style="color: #19177C">cost</span><span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">then</span>
    <span style="color: #BBB">				</span><span style="color: #19177C">dist</span>[<span style="color: #19177C">adjNodeId</span>]<span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">cost</span>
    <span style="color: #BBB">				</span><span style="color: #19177C">parentPortalId</span>[<span style="color: #19177C">adjNodeId</span>]<span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">currId</span>
    <span style="color: #BBB">				</span><span style="color: #19177C">pq</span>:<span style="color: #00F">Enqueue</span>(<span style="color: #19177C">adjNodeId</span>,<span style="color: #BBB"> </span><span style="color: #666">-</span><span style="color: #19177C">cost</span><span style="color: #BBB"> </span><span style="color: #666">-</span><span style="color: #BBB"> </span><span style="color: #19177C">h</span>)
    <span style="color: #BBB">			</span><span style="color: #008000; font-weight: bold">end</span>
    <span style="color: #BBB">		</span><span style="color: #008000; font-weight: bold">end</span><span style="color: #BBB"> </span>
    <span style="color: #BBB">	</span><span style="color: #008000; font-weight: bold">end</span>
    <span style="color: #BBB">	</span><span style="color: #19177C">debug</span>.<span style="color: #00F">profileend</span>()

    <span style="color: #BBB">	</span><span style="color: #19177C">debug</span>.<span style="color: #00F">profilebegin</span>(<span style="color: #BA2121">&quot;Portal Path Reconstruction&quot;</span>)
    <span style="color: #BBB">	</span><span style="color: #008000; font-weight: bold">if</span><span style="color: #BBB"> </span><span style="color: #19177C">pathFound</span><span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">then</span>
    <span style="color: #BBB">		</span><span style="color: #008000; font-weight: bold">local</span><span style="color: #BBB"> </span><span style="color: #19177C">path</span>,<span style="color: #BBB"> </span><span style="color: #19177C">pathSectorsPos</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span>{},<span style="color: #BBB"> </span>{}
    <span style="color: #BBB">		</span><span style="color: #008000; font-weight: bold">local</span><span style="color: #BBB"> </span><span style="color: #19177C">currPortalId</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">goalId</span>
    <span style="color: #BBB">		</span><span style="color: #008000; font-weight: bold">local</span><span style="color: #BBB"> </span><span style="color: #19177C">currSectorPos</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">portalFromId</span>[<span style="color: #19177C">goalId</span>].<span style="color: #19177C">SectorPos</span>

    <span style="color: #BBB">		</span><span style="color: #008000">table.insert</span>(<span style="color: #19177C">pathSectorsPos</span>,<span style="color: #BBB"> </span><span style="color: #19177C">currSectorPos</span>)

    <span style="color: #BBB">		</span><span style="color: #008000; font-weight: bold">local</span><span style="color: #BBB"> </span><span style="color: #19177C">chunk</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">debugChunk</span>[<span style="color: #19177C">currSectorPos</span>.X][<span style="color: #19177C">currSectorPos</span>.Y]

    <span style="color: #BBB">		</span><span style="color: #008000; font-weight: bold">local</span><span style="color: #BBB"> </span><span style="color: #19177C">currPortal</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">portalFromId</span>[<span style="color: #19177C">currPortalId</span>].<span style="color: #19177C">CellPos</span>
    <span style="color: #BBB">		</span><span style="color: #00F">DebugInsertProperties</span>(<span style="color: #19177C">chunk</span>.Display[<span style="color: #19177C">DebugEnums</span>.DebugDisplayMode.Integration],<span style="color: #BBB"> </span>{
    <span style="color: #BBB">			</span><span style="color: #19177C">Type</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">DebugEnums</span>.DebugObject.Box,
    <span style="color: #BBB">			</span><span style="color: #19177C">SectorPosition</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">currSectorPos</span>,
    <span style="color: #BBB">			</span><span style="color: #19177C">Position</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #00F">DebugGetCellCenter</span>(<span style="color: #19177C">currPortal</span>,<span style="color: #BBB"> </span><span style="color: #19177C">currSectorPos</span>)<span style="color: #BBB"> </span><span style="color: #666">+</span><span style="color: #BBB"> </span><span style="color: #19177C">Vector3</span>.yAxis<span style="color: #BBB"> </span><span style="color: #666">*</span><span style="color: #BBB"> </span><span style="color: #19177C">sectorGrid</span>[<span style="color: #19177C">currSectorPos</span>.X][<span style="color: #19177C">currSectorPos</span>.Y].<span style="color: #19177C">Heightmap</span>[<span style="color: #19177C">currPortal</span>.X][<span style="color: #19177C">currPortal</span>.Y],
    <span style="color: #BBB">			</span><span style="color: #19177C">Size</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">DebugPortalSize</span>,
    <span style="color: #BBB">			</span><span style="color: #19177C">Color</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">DebugPortalColor</span><span style="color: #BBB">	</span>
    <span style="color: #BBB">		</span>})

    <span style="color: #BBB">		</span><span style="color: #008000; font-weight: bold">while</span><span style="color: #BBB"> </span><span style="color: #19177C">currPortalId</span><span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">do</span>
    <span style="color: #BBB">			</span><span style="color: #008000">table.insert</span>(<span style="color: #19177C">path</span>,<span style="color: #BBB"> </span><span style="color: #19177C">portalFromId</span>[<span style="color: #19177C">currPortalId</span>])
    <span style="color: #BBB">			</span><span style="color: #008000; font-weight: bold">local</span><span style="color: #BBB"> </span><span style="color: #19177C">prevPortalId</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">currPortalId</span>
    <span style="color: #BBB">			</span><span style="color: #008000; font-weight: bold">local</span><span style="color: #BBB"> </span><span style="color: #19177C">prevSector</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">currSectorPos</span>
    <span style="color: #BBB">			</span><span style="color: #19177C">currPortalId</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">parentPortalId</span>[<span style="color: #19177C">currPortalId</span>]

    <span style="color: #BBB">			</span><span style="color: #008000; font-weight: bold">if</span><span style="color: #BBB"> </span><span style="color: #19177C">currPortalId</span><span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">then</span>
    <span style="color: #BBB">				</span><span style="color: #008000; font-weight: bold">if</span><span style="color: #BBB"> </span><span style="color: #19177C">portalFromId</span>[<span style="color: #19177C">currPortalId</span>].<span style="color: #19177C">SectorPos</span><span style="color: #BBB"> </span><span style="color: #666">~=</span><span style="color: #BBB"> </span><span style="color: #19177C">currSectorPos</span><span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">then</span>
    <span style="color: #BBB">					</span><span style="color: #19177C">currSectorPos</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">portalFromId</span>[<span style="color: #19177C">currPortalId</span>].<span style="color: #19177C">SectorPos</span>
    <span style="color: #BBB">					</span><span style="color: #19177C">chunk</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">debugChunk</span>[<span style="color: #19177C">currSectorPos</span>.X][<span style="color: #19177C">currSectorPos</span>.Y]
    <span style="color: #BBB">					</span><span style="color: #008000">table.insert</span>(<span style="color: #19177C">pathSectorsPos</span>,<span style="color: #BBB"> </span><span style="color: #19177C">currSectorPos</span>)
    <span style="color: #BBB">				</span><span style="color: #008000; font-weight: bold">end</span>

    <span style="color: #BBB">				</span><span style="color: #008000; font-weight: bold">local</span><span style="color: #BBB"> </span><span style="color: #19177C">currPortal</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">portalFromId</span>[<span style="color: #19177C">currPortalId</span>].<span style="color: #19177C">CellPos</span>
    <span style="color: #BBB">				</span><span style="color: #008000; font-weight: bold">local</span><span style="color: #BBB"> </span><span style="color: #19177C">prevPortal</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">portalFromId</span>[<span style="color: #19177C">prevPortalId</span>].<span style="color: #19177C">CellPos</span>
    <span style="color: #BBB">				</span><span style="color: #00F">DebugInsertProperties</span>(<span style="color: #19177C">chunk</span>.Display[<span style="color: #19177C">DebugEnums</span>.DebugDisplayMode.Integration],<span style="color: #BBB"> </span>{
    <span style="color: #BBB">					</span><span style="color: #19177C">Type</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">DebugEnums</span>.DebugObject.Box,
    <span style="color: #BBB">					</span><span style="color: #19177C">SectorPosition</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">currSectorPos</span>,
    <span style="color: #BBB">					</span><span style="color: #19177C">Position</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #00F">DebugGetCellCenter</span>(<span style="color: #19177C">currPortal</span>,<span style="color: #BBB"> </span><span style="color: #19177C">currSectorPos</span>)<span style="color: #BBB"> </span><span style="color: #666">+</span><span style="color: #BBB"> </span><span style="color: #19177C">Vector3</span>.yAxis<span style="color: #BBB"> </span><span style="color: #666">*</span><span style="color: #BBB"> </span><span style="color: #19177C">sectorGrid</span>[<span style="color: #19177C">currSectorPos</span>.X][<span style="color: #19177C">currSectorPos</span>.Y].<span style="color: #19177C">Heightmap</span>[<span style="color: #19177C">currPortal</span>.X][<span style="color: #19177C">currPortal</span>.Y],
    <span style="color: #BBB">					</span><span style="color: #19177C">Size</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">DebugPortalSize</span>,
    <span style="color: #BBB">					</span><span style="color: #19177C">Color</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">DebugPortalColor</span><span style="color: #BBB">		</span>
    <span style="color: #BBB">				</span>})
    <span style="color: #BBB">				</span><span style="color: #00F">DebugInsertProperties</span>(<span style="color: #19177C">chunk</span>.Display[<span style="color: #19177C">DebugEnums</span>.DebugDisplayMode.Integration],<span style="color: #BBB"> </span>{
    <span style="color: #BBB">					</span><span style="color: #19177C">Type</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">DebugEnums</span>.DebugObject.Line,
    <span style="color: #BBB">					</span><span style="color: #19177C">SectorPosition</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">currSectorPos</span>,
    <span style="color: #BBB">					</span><span style="color: #19177C">Point1</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #00F">DebugGetCellCenter</span>(<span style="color: #19177C">prevPortal</span>,<span style="color: #BBB"> </span><span style="color: #19177C">prevSector</span>)<span style="color: #BBB"> </span><span style="color: #666">+</span><span style="color: #BBB"> </span><span style="color: #19177C">Vector3</span>.yAxis<span style="color: #BBB"> </span><span style="color: #666">*</span><span style="color: #BBB"> </span><span style="color: #19177C">sectorGrid</span>[<span style="color: #19177C">prevSector</span>.X][<span style="color: #19177C">prevSector</span>.Y].<span style="color: #19177C">Heightmap</span>[<span style="color: #19177C">prevPortal</span>.X][<span style="color: #19177C">prevPortal</span>.Y],
    <span style="color: #BBB">					</span><span style="color: #19177C">Point2</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #00F">DebugGetCellCenter</span>(<span style="color: #19177C">currPortal</span>,<span style="color: #BBB"> </span><span style="color: #19177C">currSectorPos</span>)<span style="color: #BBB"> </span><span style="color: #666">+</span><span style="color: #BBB"> </span><span style="color: #19177C">Vector3</span>.yAxis<span style="color: #BBB"> </span><span style="color: #666">*</span><span style="color: #BBB"> </span><span style="color: #19177C">sectorGrid</span>[<span style="color: #19177C">currSectorPos</span>.X][<span style="color: #19177C">currSectorPos</span>.Y].<span style="color: #19177C">Heightmap</span>[<span style="color: #19177C">currPortal</span>.X][<span style="color: #19177C">currPortal</span>.Y],
    <span style="color: #BBB">					</span><span style="color: #19177C">Color</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">DebugPortalColor</span><span style="color: #BBB">	</span>
    <span style="color: #BBB">				</span>})
    <span style="color: #BBB">			</span><span style="color: #008000; font-weight: bold">end</span>
    <span style="color: #BBB">		</span><span style="color: #008000; font-weight: bold">end</span>

    <span style="color: #BBB">		</span><span style="color: #008000; font-weight: bold">if</span><span style="color: #BBB"> </span><span style="color: #19177C">debugView</span><span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">then</span>
    <span style="color: #BBB">			</span><span style="color: #008000">print</span>(<span style="color: #BA2121">&quot;Found path between {&quot;</span><span style="color: #666">..</span><span style="color: #19177C">Utils</span>.<span style="color: #00F">Vector3ToString</span>(<span style="color: #19177C">sourcePos</span>,<span style="color: #BBB"> </span><span style="color: #666">3</span>)..<span style="color: #BA2121">&quot;} and {&quot;</span><span style="color: #666">..</span><span style="color: #19177C">Utils</span>.<span style="color: #00F">Vector3ToString</span>(<span style="color: #19177C">targetPos</span>,<span style="color: #BBB"> </span><span style="color: #666">3</span>)..<span style="color: #BA2121">&quot;} in &quot;</span><span style="color: #666">..</span>(<span style="color: #008000">os.clock</span>()<span style="color: #BBB"> </span><span style="color: #666">-</span><span style="color: #BBB"> </span><span style="color: #19177C">t</span>)..<span style="color: #BA2121">&quot; seconds&quot;</span>)
    <span style="color: #BBB">		</span><span style="color: #008000; font-weight: bold">end</span>
    <span style="color: #BBB">		</span><span style="color: #19177C">debug</span>.<span style="color: #00F">profileend</span>()
    <span style="color: #BBB">		</span><span style="color: #008000; font-weight: bold">return</span><span style="color: #BBB"> </span><span style="color: #19177C">path</span>,<span style="color: #BBB"> </span><span style="color: #19177C">pathSectorsPos</span>
    <span style="color: #BBB">	</span><span style="color: #008000; font-weight: bold">elseif</span><span style="color: #BBB"> </span><span style="color: #19177C">debugView</span><span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">then</span>
    <span style="color: #BBB">		</span><span style="color: #008000">warn</span>(<span style="color: #BA2121">&quot;Could not find path between {&quot;</span><span style="color: #666">..</span><span style="color: #19177C">Utils</span>.<span style="color: #00F">Vector3ToString</span>(<span style="color: #19177C">sourcePos</span>,<span style="color: #BBB"> </span><span style="color: #666">3</span>)..<span style="color: #BA2121">&quot;} and {&quot;</span><span style="color: #666">..</span><span style="color: #19177C">Utils</span>.<span style="color: #00F">Vector3ToString</span>(<span style="color: #19177C">targetPos</span>,<span style="color: #BBB"> </span><span style="color: #666">3</span>)..<span style="color: #BA2121">&quot;}&quot;</span>)
    <span style="color: #BBB">		</span><span style="color: #19177C">debug</span>.<span style="color: #00F">profileend</span>()
    <span style="color: #BBB">		</span><span style="color: #008000; font-weight: bold">return</span><span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">nil</span>,<span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">nil</span>
    <span style="color: #BBB">	</span><span style="color: #008000; font-weight: bold">end</span>
    <span style="color: #008000; font-weight: bold">end</span>
    </pre></div>
</div>

<div class="infobox" data-title="Integration Field">
    <h1>Integration Field</h1>
    <p>Using the approximate path and previously calculated cost fields, a flood fill algorithm is run on every sector in the path such that integrated cost values grow outwards starting from a given target position.</p>
    <div class="fig-container" style="text-align: center">
        <figure>
            <img src="img/intexample.png" alt="" style="max-height: 600px">
            <figcaption>Cell values get bigger the further away the cell is from its sector's portal</figcaption>
        </figure>
    </div>

    <!-- HTML generated using hilite.me --><div style="background: #f8f8f8; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%;"><span></span><span style="color: #008000; font-weight: bold">function</span><span style="color: #BBB"> </span><span style="color: #00F; font-weight: bold">SectorInfo</span>:<span style="color: #00F">CalculateIntegrationField</span>(<span style="color: #19177C">fieldId</span>:<span style="color: #BBB"> </span>number,<span style="color: #BBB"> </span><span style="color: #19177C">startCells</span>:<span style="color: #BBB"> </span>table,<span style="color: #BBB"> </span><span style="color: #19177C">targetPos</span>:<span style="color: #BBB"> </span>Vector3)
    <span style="color: #BBB">	</span><span style="color: #008000; font-weight: bold">local</span><span style="color: #BBB"> </span><span style="color: #19177C">targetCellPos</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">Utils</span>.<span style="color: #00F">ConvertToGlobalCellPos</span>(<span style="color: #19177C">targetPos</span>)

    <span style="color: #BBB">	</span><span style="color: #008000; font-weight: bold">if</span><span style="color: #BBB"> </span><span style="color: #19177C">self</span>.IntegrationField[<span style="color: #19177C">fieldId</span>]<span style="color: #BBB"> </span><span style="color: #666">==</span><span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">nil</span><span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">then</span>
    <span style="color: #BBB">		</span><span style="color: #19177C">self</span>.IntegrationField[<span style="color: #19177C">fieldId</span>]<span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span>{}
    <span style="color: #BBB">	</span><span style="color: #008000; font-weight: bold">end</span>
    <span style="color: #BBB">	</span><span style="color: #008000; font-weight: bold">if</span><span style="color: #BBB"> </span><span style="color: #19177C">self</span>.CellFlags[<span style="color: #19177C">fieldId</span>]<span style="color: #BBB"> </span><span style="color: #666">==</span><span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">nil</span><span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">then</span>
    <span style="color: #BBB">		</span><span style="color: #19177C">self</span>.CellFlags[<span style="color: #19177C">fieldId</span>]<span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span>{}
    <span style="color: #BBB">	</span><span style="color: #008000; font-weight: bold">end</span>

    <span style="color: #BBB">	</span><span style="color: #008000; font-weight: bold">local</span><span style="color: #BBB"> </span><span style="color: #19177C">costs</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">self</span>.CostField
    <span style="color: #BBB">	</span><span style="color: #008000; font-weight: bold">local</span><span style="color: #BBB"> </span><span style="color: #19177C">field</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">self</span>.IntegrationField[<span style="color: #19177C">fieldId</span>]
    <span style="color: #BBB">	</span><span style="color: #008000; font-weight: bold">local</span><span style="color: #BBB"> </span><span style="color: #19177C">fieldFlags</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">self</span>.CellFlags[<span style="color: #19177C">fieldId</span>]

    <span style="color: #BBB">	</span><span style="color: #008000; font-weight: bold">if</span><span style="color: #BBB"> </span><span style="color: #666">#</span><span style="color: #19177C">field</span><span style="color: #BBB"> </span><span style="color: #666">&gt;</span><span style="color: #BBB"> </span><span style="color: #666">0</span><span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">then</span>
    <span style="color: #BBB">		</span><span style="color: #008000; font-weight: bold">local</span><span style="color: #BBB"> </span><span style="color: #19177C">cnt</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #666">0</span>
    <span style="color: #BBB">		</span><span style="color: #008000; font-weight: bold">for</span><span style="color: #BBB"> </span><span style="color: #19177C">_</span>,<span style="color: #BBB"> </span><span style="color: #19177C">cell</span><span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">in</span><span style="color: #BBB"> </span><span style="color: #19177C">startCells</span><span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">do</span><span style="color: #BBB">		</span>
    <span style="color: #BBB">			</span><span style="color: #008000; font-weight: bold">if</span><span style="color: #BBB"> </span><span style="color: #19177C">field</span>[<span style="color: #19177C">cell</span>.Pos.X][<span style="color: #19177C">cell</span>.Pos.Y]<span style="color: #BBB"> </span><span style="color: #666">==</span><span style="color: #BBB"> </span><span style="color: #19177C">cell</span>.Val<span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">then</span>
    <span style="color: #BBB">				</span><span style="color: #19177C">cnt</span><span style="color: #BBB"> </span><span style="color: #666">+=</span><span style="color: #BBB"> </span><span style="color: #666">1</span>
    <span style="color: #BBB">			</span><span style="color: #008000; font-weight: bold">end</span>
    <span style="color: #BBB">		</span><span style="color: #008000; font-weight: bold">end</span>
    <span style="color: #BBB">		</span><span style="color: #008000; font-weight: bold">if</span><span style="color: #BBB"> </span><span style="color: #19177C">cnt</span><span style="color: #BBB"> </span><span style="color: #666">==</span><span style="color: #BBB"> </span><span style="color: #666">#</span><span style="color: #19177C">startCells</span><span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">then</span>
    <span style="color: #BBB">			</span><span style="color: #008000; font-weight: bold">return</span><span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">false</span>
    <span style="color: #BBB">		</span><span style="color: #008000; font-weight: bold">end</span>
    <span style="color: #BBB">	</span><span style="color: #008000; font-weight: bold">end</span>

    <span style="color: #BBB">	</span><span style="color: #008000; font-weight: bold">for</span><span style="color: #BBB"> </span><span style="color: #19177C">i</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #666">0</span>,<span style="color: #BBB"> </span><span style="color: #19177C">cellCount</span><span style="color: #BBB"> </span><span style="color: #666">+</span><span style="color: #BBB"> </span><span style="color: #666">1</span><span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">do</span>
    <span style="color: #BBB">		</span><span style="color: #19177C">field</span>[<span style="color: #19177C">i</span>]<span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span>{}
    <span style="color: #BBB">		</span><span style="color: #19177C">fieldFlags</span>[<span style="color: #19177C">i</span>]<span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span>{}
    <span style="color: #BBB">		</span><span style="color: #008000; font-weight: bold">for</span><span style="color: #BBB"> </span><span style="color: #19177C">j</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #666">0</span>,<span style="color: #BBB"> </span><span style="color: #19177C">cellCount</span><span style="color: #BBB"> </span><span style="color: #666">+</span><span style="color: #BBB"> </span><span style="color: #666">1</span><span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">do</span>
    <span style="color: #BBB">			</span><span style="color: #19177C">field</span>[<span style="color: #19177C">i</span>][<span style="color: #19177C">j</span>]<span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">Utils</span>.inf
    <span style="color: #BBB">			</span><span style="color: #19177C">fieldFlags</span>[<span style="color: #19177C">i</span>][<span style="color: #19177C">j</span>]<span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #666">0</span>
    <span style="color: #BBB">		</span><span style="color: #008000; font-weight: bold">end</span>
    <span style="color: #BBB">	</span><span style="color: #008000; font-weight: bold">end</span>

    <span style="color: #BBB">	</span><span style="color: #008000; font-weight: bold">local</span><span style="color: #BBB"> </span><span style="color: #19177C">q</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">Queue</span>.<span style="color: #00F">new</span>()
    <span style="color: #BBB">	</span><span style="color: #008000; font-weight: bold">for</span><span style="color: #BBB"> </span><span style="color: #19177C">_</span>,<span style="color: #BBB"> </span><span style="color: #19177C">cell</span><span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">in</span><span style="color: #BBB"> </span><span style="color: #19177C">startCells</span><span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">do</span><span style="color: #BBB">		</span>
    <span style="color: #BBB">		</span><span style="color: #19177C">field</span>[<span style="color: #19177C">cell</span>.Pos.X][<span style="color: #19177C">cell</span>.Pos.Y]<span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">cell</span>.Val
    <span style="color: #BBB">		</span><span style="color: #19177C">fieldFlags</span>[<span style="color: #19177C">cell</span>.Pos.X][<span style="color: #19177C">cell</span>.Pos.Y]<span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">cell</span>.Flags

    <span style="color: #BBB">		</span><span style="color: #19177C">q</span>:<span style="color: #00F">Enqueue</span>(<span style="color: #19177C">cell</span>.Pos)
    <span style="color: #BBB">	</span><span style="color: #008000; font-weight: bold">end</span>
    <span style="color: #BBB">	</span>
    <span style="color: #BBB">	</span><span style="color: #008000; font-weight: bold">while</span><span style="color: #BBB"> </span><span style="color: #A2F; font-weight: bold">not</span><span style="color: #BBB"> </span><span style="color: #19177C">q</span>:<span style="color: #00F">IsEmpty</span>()<span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">do</span>
    <span style="color: #BBB">		</span><span style="color: #008000; font-weight: bold">local</span><span style="color: #BBB"> </span><span style="color: #19177C">curr</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">q</span>:<span style="color: #00F">Dequeue</span>()

    <span style="color: #BBB">		</span><span style="color: #008000; font-weight: bold">for</span><span style="color: #BBB"> </span><span style="color: #19177C">_</span>,<span style="color: #BBB"> </span><span style="color: #19177C">dir</span><span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">in</span><span style="color: #BBB"> </span><span style="color: #19177C">dirs</span><span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">do</span>
    <span style="color: #BBB">			</span><span style="color: #008000; font-weight: bold">local</span><span style="color: #BBB"> </span><span style="color: #008000">next</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">curr</span><span style="color: #BBB"> </span><span style="color: #666">+</span><span style="color: #BBB"> </span><span style="color: #19177C">dir</span>

    <span style="color: #BBB">			</span><span style="color: #008000; font-weight: bold">if</span><span style="color: #BBB"> </span><span style="color: #A2F; font-weight: bold">not</span><span style="color: #BBB"> </span><span style="color: #19177C">Utils</span>.<span style="color: #00F">IsValidCellPos</span>(<span style="color: #008000">next</span>)<span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">then</span>
    <span style="color: #BBB">				</span><span style="color: #19177C">continue</span>
    <span style="color: #BBB">			</span><span style="color: #008000; font-weight: bold">end</span>

    <span style="color: #BBB">			</span><span style="color: #008000; font-weight: bold">if</span><span style="color: #BBB"> </span><span style="color: #19177C">costs</span>[<span style="color: #008000">next</span>.<span style="color: #19177C">X</span>][<span style="color: #008000">next</span>.<span style="color: #19177C">Y</span>]<span style="color: #BBB"> </span><span style="color: #666">==</span><span style="color: #BBB"> </span><span style="color: #19177C">SectorInfo</span>.MaxCost<span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">then</span>
    <span style="color: #BBB">				</span><span style="color: #19177C">field</span>[<span style="color: #008000">next</span>.<span style="color: #19177C">X</span>][<span style="color: #008000">next</span>.<span style="color: #19177C">Y</span>]<span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">SectorInfo</span>.MaxIntegratedCost
    <span style="color: #BBB">				</span><span style="color: #19177C">continue</span>
    <span style="color: #BBB">			</span><span style="color: #008000; font-weight: bold">end</span>

    <span style="color: #BBB">			</span><span style="color: #008000; font-weight: bold">local</span><span style="color: #BBB"> </span><span style="color: #19177C">cost</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">field</span>[<span style="color: #19177C">curr</span>.X][<span style="color: #19177C">curr</span>.Y]<span style="color: #BBB"> </span><span style="color: #666">+</span><span style="color: #BBB"> </span><span style="color: #19177C">costs</span>[<span style="color: #008000">next</span>.<span style="color: #19177C">X</span>][<span style="color: #008000">next</span>.<span style="color: #19177C">Y</span>]
    <span style="color: #BBB">			</span><span style="color: #008000; font-weight: bold">if</span><span style="color: #BBB"> </span><span style="color: #19177C">field</span>[<span style="color: #008000">next</span>.<span style="color: #19177C">X</span>][<span style="color: #008000">next</span>.<span style="color: #19177C">Y</span>]<span style="color: #BBB"> </span><span style="color: #666">&gt;</span><span style="color: #BBB"> </span><span style="color: #19177C">cost</span><span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">then</span>
    <span style="color: #BBB">				</span><span style="color: #19177C">field</span>[<span style="color: #008000">next</span>.<span style="color: #19177C">X</span>][<span style="color: #008000">next</span>.<span style="color: #19177C">Y</span>]<span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">cost</span>
    <span style="color: #BBB">				</span><span style="color: #19177C">q</span>:<span style="color: #00F">Enqueue</span>(<span style="color: #008000">next</span>)
    <span style="color: #BBB">			</span><span style="color: #008000; font-weight: bold">end</span>
    <span style="color: #BBB">		</span><span style="color: #008000; font-weight: bold">end</span>
    <span style="color: #BBB">	</span><span style="color: #008000; font-weight: bold">end</span>

    <span style="color: #BBB">	</span><span style="color: #008000; font-weight: bold">return</span><span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">true</span>
    <span style="color: #008000; font-weight: bold">end</span>
    </pre></div>
</div>

<div class="infobox" data-title="Flow Field">
    <h1>Flow Field</h1>
    <p>Based on the previously calculated integration fields, the algorithm goes through each cell of the path's sectors
        and uses the minimum value of the adjacent cells to establish the direction in which an agent should go.</p>
    <div class="fig-container" style="text-align: center">
        <figure>
            <img src="img/flowexample.png" alt="" style="max-height: 600px">
            <figcaption>Each agent will use the direction vector of the cell that it's on to travel to its destination.</figcaption>
        </figure>
    </div>

    <!-- HTML generated using hilite.me --><div style="background: #f8f8f8; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%;"><span></span><span style="color: #008000; font-weight: bold">function</span><span style="color: #BBB"> </span><span style="color: #00F; font-weight: bold">SectorInfo</span>:<span style="color: #00F">CalculateFlowField</span>(<span style="color: #19177C">fieldId</span>:<span style="color: #BBB"> </span>number,<span style="color: #BBB"> </span><span style="color: #19177C">integrationChanged</span>:<span style="color: #BBB"> </span>boolean)<span style="color: #BBB">	</span>
    <span style="color: #BBB">	</span><span style="color: #008000; font-weight: bold">if</span><span style="color: #BBB"> </span><span style="color: #A2F; font-weight: bold">not</span><span style="color: #BBB"> </span><span style="color: #19177C">integrationChanged</span><span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">then</span>
    <span style="color: #BBB">		</span><span style="color: #008000; font-weight: bold">return</span>
    <span style="color: #BBB">	</span><span style="color: #008000; font-weight: bold">end</span>

    <span style="color: #BBB">	</span><span style="color: #008000; font-weight: bold">if</span><span style="color: #BBB"> </span><span style="color: #19177C">self</span>.FlowField[<span style="color: #19177C">fieldId</span>]<span style="color: #BBB"> </span><span style="color: #666">==</span><span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">nil</span><span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">then</span>
    <span style="color: #BBB">		</span><span style="color: #19177C">self</span>.FlowField[<span style="color: #19177C">fieldId</span>]<span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span>{}
    <span style="color: #BBB">	</span><span style="color: #008000; font-weight: bold">else</span>
    <span style="color: #BBB">		</span><span style="color: #19177C">table</span>.<span style="color: #00F">clear</span>(<span style="color: #19177C">self</span>.FlowField[<span style="color: #19177C">fieldId</span>])
    <span style="color: #BBB">	</span><span style="color: #008000; font-weight: bold">end</span>

    <span style="color: #BBB">	</span><span style="color: #008000; font-weight: bold">local</span><span style="color: #BBB"> </span><span style="color: #19177C">flowField</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">self</span>.FlowField[<span style="color: #19177C">fieldId</span>]
    <span style="color: #BBB">	</span><span style="color: #008000; font-weight: bold">local</span><span style="color: #BBB"> </span><span style="color: #19177C">intField</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">self</span>.IntegrationField[<span style="color: #19177C">fieldId</span>]
    <span style="color: #BBB">	</span><span style="color: #008000; font-weight: bold">local</span><span style="color: #BBB"> </span><span style="color: #19177C">fieldFlags</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">self</span>.CellFlags[<span style="color: #19177C">fieldId</span>]

    <span style="color: #BBB">	</span><span style="color: #008000; font-weight: bold">for</span><span style="color: #BBB"> </span><span style="color: #19177C">i</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #666">1</span>,<span style="color: #BBB"> </span><span style="color: #19177C">cellCount</span><span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">do</span>
    <span style="color: #BBB">		</span><span style="color: #19177C">flowField</span>[<span style="color: #19177C">i</span>]<span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span>{}
    <span style="color: #BBB">		</span><span style="color: #008000; font-weight: bold">for</span><span style="color: #BBB"> </span><span style="color: #19177C">j</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #666">1</span>,<span style="color: #BBB"> </span><span style="color: #19177C">cellCount</span><span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">do</span>
    <span style="color: #BBB">			</span><span style="color: #008000; font-weight: bold">local</span><span style="color: #BBB"> </span><span style="color: #19177C">cellPos</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">Vector2</span>.<span style="color: #00F">new</span>(<span style="color: #19177C">i</span>,<span style="color: #BBB"> </span><span style="color: #19177C">j</span>)
    <span style="color: #BBB">			</span><span style="color: #008000; font-weight: bold">local</span><span style="color: #BBB"> </span><span style="color: #19177C">minVal</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">SectorInfo</span>.MaxIntegratedCost
    <span style="color: #BBB">			</span><span style="color: #008000; font-weight: bold">local</span><span style="color: #BBB"> </span><span style="color: #19177C">minDir</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">Vector2</span>.zero

    <span style="color: #BBB">			</span><span style="color: #008000; font-weight: bold">if</span><span style="color: #BBB"> </span><span style="color: #008000">bit32.band</span>(<span style="color: #19177C">fieldFlags</span>[<span style="color: #19177C">i</span>][<span style="color: #19177C">j</span>],<span style="color: #BBB"> </span><span style="color: #19177C">SectorInfo</span>.Flags.Goal)<span style="color: #BBB"> </span><span style="color: #666">~=</span><span style="color: #BBB"> </span><span style="color: #666">0</span><span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">then</span>
    <span style="color: #BBB">				</span><span style="color: #19177C">flowField</span>[<span style="color: #19177C">i</span>][<span style="color: #19177C">j</span>]<span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">minDir</span>
    <span style="color: #BBB">				</span><span style="color: #19177C">continue</span>
    <span style="color: #BBB">			</span><span style="color: #008000; font-weight: bold">end</span>

    <span style="color: #BBB">			</span><span style="color: #008000; font-weight: bold">for</span><span style="color: #BBB"> </span><span style="color: #19177C">_</span>,<span style="color: #BBB"> </span><span style="color: #19177C">dir</span><span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">in</span><span style="color: #BBB"> </span><span style="color: #19177C">flowDirs</span><span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">do</span>
    <span style="color: #BBB">				</span><span style="color: #008000; font-weight: bold">local</span><span style="color: #BBB"> </span><span style="color: #19177C">adjPos</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">cellPos</span><span style="color: #BBB"> </span><span style="color: #666">+</span><span style="color: #BBB"> </span><span style="color: #19177C">dir</span>

    <span style="color: #BBB">				</span><span style="color: #008000; font-weight: bold">if</span><span style="color: #BBB"> </span><span style="color: #19177C">minVal</span><span style="color: #BBB"> </span><span style="color: #666">&gt;</span><span style="color: #BBB"> </span><span style="color: #19177C">intField</span>[<span style="color: #19177C">adjPos</span>.X][<span style="color: #19177C">adjPos</span>.Y]<span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">then</span>
    <span style="color: #BBB">					</span><span style="color: #19177C">minVal</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">intField</span>[<span style="color: #19177C">adjPos</span>.X][<span style="color: #19177C">adjPos</span>.Y]
    <span style="color: #BBB">					</span><span style="color: #19177C">minDir</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span>(<span style="color: #19177C">adjPos</span><span style="color: #BBB"> </span><span style="color: #666">-</span><span style="color: #BBB"> </span><span style="color: #19177C">cellPos</span>).<span style="color: #19177C">Unit</span>
    <span style="color: #BBB">				</span><span style="color: #008000; font-weight: bold">end</span>
    <span style="color: #BBB">			</span><span style="color: #008000; font-weight: bold">end</span>

    <span style="color: #BBB">			</span><span style="color: #19177C">flowField</span>[<span style="color: #19177C">i</span>][<span style="color: #19177C">j</span>]<span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">minDir</span>
    <span style="color: #BBB">		</span><span style="color: #008000; font-weight: bold">end</span>
    <span style="color: #BBB">	</span><span style="color: #008000; font-weight: bold">end</span>
    <span style="color: #008000; font-weight: bold">end</span>
    </pre></div>

    <!-- HTML generated using hilite.me --><div style="background: #f8f8f8; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%;"><span></span><span style="color: #008000; font-weight: bold">local</span><span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">function</span><span style="color: #BBB"> </span><span style="color: #00F">CalculateFlowField</span>(<span style="color: #19177C">sourcePos</span>:<span style="color: #BBB"> </span>Vector3,<span style="color: #BBB"> </span><span style="color: #19177C">targetPos</span>:<span style="color: #BBB"> </span>Vector3)
    <span style="color: #BBB">	</span><span style="color: #19177C">debug</span>.<span style="color: #00F">profilebegin</span>(<span style="color: #BA2121">&quot;Flow Field Generation&quot;</span>)
    <span style="color: #BBB">	</span><span style="color: #008000; font-weight: bold">if</span><span style="color: #BBB"> </span><span style="color: #19177C">debugView</span><span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">then</span>
    <span style="color: #BBB">		</span><span style="color: #008000; font-weight: bold">for</span><span style="color: #BBB"> </span><span style="color: #19177C">i</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #666">-</span><span style="color: #19177C">sectorCount</span>,<span style="color: #BBB"> </span><span style="color: #19177C">sectorCount</span><span style="color: #BBB"> </span><span style="color: #666">-</span><span style="color: #BBB"> </span><span style="color: #666">1</span><span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">do</span>
    <span style="color: #BBB">			</span><span style="color: #008000; font-weight: bold">for</span><span style="color: #BBB"> </span><span style="color: #19177C">j</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #666">-</span><span style="color: #19177C">sectorCount</span>,<span style="color: #BBB"> </span><span style="color: #19177C">sectorCount</span><span style="color: #BBB"> </span><span style="color: #666">-</span><span style="color: #BBB"> </span><span style="color: #666">1</span><span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">do</span>
    <span style="color: #BBB">				</span><span style="color: #008000; font-weight: bold">local</span><span style="color: #BBB"> </span><span style="color: #19177C">chunk</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">debugChunk</span>[<span style="color: #19177C">i</span>][<span style="color: #19177C">j</span>]
    <span style="color: #BBB">				</span><span style="color: #19177C">chunk</span>:<span style="color: #00F">ClearDisplayMode</span>(<span style="color: #19177C">DebugEnums</span>.DebugDisplayMode.Integration)
    <span style="color: #BBB">				</span><span style="color: #19177C">chunk</span>:<span style="color: #00F">ClearDisplayMode</span>(<span style="color: #19177C">DebugEnums</span>.DebugDisplayMode.Flow)
    <span style="color: #BBB">				</span><span style="color: #19177C">ClearDebugDataEvent</span>:<span style="color: #00F">FireAllClients</span>(<span style="color: #19177C">DebugEnums</span>.DebugDisplayMode.Integration,<span style="color: #BBB"> </span><span style="color: #19177C">i</span>,<span style="color: #BBB"> </span><span style="color: #19177C">j</span>)
    <span style="color: #BBB">				</span><span style="color: #19177C">ClearDebugDataEvent</span>:<span style="color: #00F">FireAllClients</span>(<span style="color: #19177C">DebugEnums</span>.DebugDisplayMode.Flow,<span style="color: #BBB"> </span><span style="color: #19177C">i</span>,<span style="color: #BBB"> </span><span style="color: #19177C">j</span>)
    <span style="color: #BBB">			</span><span style="color: #008000; font-weight: bold">end</span>
    <span style="color: #BBB">		</span><span style="color: #008000; font-weight: bold">end</span>
    <span style="color: #BBB">	</span><span style="color: #008000; font-weight: bold">end</span>

    <span style="color: #BBB">	</span><span style="color: #008000; font-weight: bold">local</span><span style="color: #BBB"> </span><span style="color: #19177C">fieldId</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">Utils</span>.<span style="color: #00F">ConvertCellPosToNumber</span>(<span style="color: #19177C">Utils</span>.<span style="color: #00F">ConvertToLocalCellPos</span>(<span style="color: #19177C">targetPos</span>))
    <span style="color: #BBB">	</span><span style="color: #008000; font-weight: bold">local</span><span style="color: #BBB"> </span><span style="color: #19177C">idOffset</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">cellCount</span><span style="color: #BBB"> </span><span style="color: #666">*</span><span style="color: #BBB"> </span><span style="color: #19177C">cellCount</span><span style="color: #BBB"> </span><span style="color: #666">*</span><span style="color: #BBB"> </span><span style="color: #19177C">sectorCount</span><span style="color: #BBB"> </span><span style="color: #666">*</span><span style="color: #BBB"> </span><span style="color: #666">2</span>
    <span style="color: #BBB">	</span><span style="color: #008000; font-weight: bold">local</span><span style="color: #BBB"> </span><span style="color: #19177C">fieldIdAdd</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">nil</span>
    <span style="color: #BBB">	</span>
    <span style="color: #BBB">	</span><span style="color: #008000; font-weight: bold">local</span><span style="color: #BBB"> </span><span style="color: #19177C">sourceGridPos</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">Utils</span>.<span style="color: #00F">ConvertToSectorGridPos</span>(<span style="color: #19177C">sourcePos</span>)
    <span style="color: #BBB">	</span><span style="color: #008000; font-weight: bold">local</span><span style="color: #BBB"> </span><span style="color: #19177C">pathId</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">Utils</span>.<span style="color: #00F">ConvertCellPosToNumber</span>(<span style="color: #19177C">Utils</span>.<span style="color: #00F">ConvertToLocalCellPos</span>(<span style="color: #19177C">Vector3</span>.<span style="color: #00F">new</span>(<span style="color: #19177C">sourceGridPos</span>.X,<span style="color: #BBB"> </span><span style="color: #666">0</span>,<span style="color: #BBB"> </span><span style="color: #19177C">sourceGridPos</span>.Y)<span style="color: #BBB"> </span><span style="color: #666">*</span><span style="color: #BBB"> </span>(<span style="color: #19177C">sectorSize</span><span style="color: #BBB"> </span><span style="color: #666">/</span><span style="color: #BBB"> </span><span style="color: #19177C">cellSize</span>)))<span style="color: #BBB"> </span><span style="color: #666">+</span><span style="color: #BBB"> </span><span style="color: #19177C">fieldId</span><span style="color: #BBB"> </span><span style="color: #666">*</span><span style="color: #BBB"> </span><span style="color: #19177C">idOffset</span>
    <span style="color: #BBB">	</span><span style="color: #008000; font-weight: bold">if</span><span style="color: #BBB"> </span><span style="color: #19177C">pathCache</span>[<span style="color: #19177C">pathId</span>]<span style="color: #BBB"> </span><span style="color: #666">~=</span><span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">nil</span><span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">then</span>
    <span style="color: #BBB">		</span><span style="color: #008000; font-weight: bold">local</span><span style="color: #BBB"> </span><span style="color: #19177C">ok</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">true</span>
    <span style="color: #BBB">		</span><span style="color: #008000; font-weight: bold">for</span><span style="color: #BBB"> </span><span style="color: #19177C">idx</span>,<span style="color: #BBB"> </span><span style="color: #19177C">fieldId</span><span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">in</span><span style="color: #BBB"> </span><span style="color: #19177C">pathCache</span>[<span style="color: #19177C">pathId</span>].<span style="color: #19177C">FieldIdList</span><span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">do</span>
    <span style="color: #BBB">			</span><span style="color: #008000; font-weight: bold">local</span><span style="color: #BBB"> </span><span style="color: #19177C">sectorPos</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">pathCache</span>[<span style="color: #19177C">pathId</span>].<span style="color: #19177C">PathSectorsPos</span>[<span style="color: #19177C">idx</span>]
    <span style="color: #BBB">			</span><span style="color: #008000; font-weight: bold">if</span><span style="color: #BBB"> </span><span style="color: #19177C">sectorGrid</span>[<span style="color: #19177C">sectorPos</span>.X][<span style="color: #19177C">sectorPos</span>.Y].<span style="color: #19177C">IntegrationField</span>[<span style="color: #19177C">fieldId</span>]<span style="color: #BBB"> </span><span style="color: #666">==</span><span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">nil</span><span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">then</span>
    <span style="color: #BBB">				</span><span style="color: #19177C">ok</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">false</span>
    <span style="color: #BBB">				</span><span style="color: #19177C">pathCache</span>[<span style="color: #19177C">pathId</span>]<span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">nil</span>
    <span style="color: #BBB">				</span><span style="color: #008000; font-weight: bold">break</span>
    <span style="color: #BBB">			</span><span style="color: #008000; font-weight: bold">end</span>
    <span style="color: #BBB">		</span><span style="color: #008000; font-weight: bold">end</span>

    <span style="color: #BBB">		</span><span style="color: #008000; font-weight: bold">if</span><span style="color: #BBB"> </span><span style="color: #19177C">ok</span><span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">then</span>
    <span style="color: #BBB">			</span><span style="color: #00F">DebugSetupFlowFieldDisplay</span>(<span style="color: #19177C">pathCache</span>[<span style="color: #19177C">pathId</span>].<span style="color: #19177C">FieldIdList</span>,<span style="color: #BBB"> </span><span style="color: #19177C">pathCache</span>[<span style="color: #19177C">pathId</span>].<span style="color: #19177C">PathSectorsPos</span>,<span style="color: #BBB"> </span><span style="color: #19177C">targetPos</span>)
    <span style="color: #BBB">			</span><span style="color: #008000; font-weight: bold">return</span><span style="color: #BBB"> </span><span style="color: #19177C">pathCache</span>[<span style="color: #19177C">pathId</span>].<span style="color: #19177C">FieldIdList</span>,<span style="color: #BBB"> </span><span style="color: #19177C">pathCache</span>[<span style="color: #19177C">pathId</span>].<span style="color: #19177C">PathSectorsPos</span>
    <span style="color: #BBB">		</span><span style="color: #008000; font-weight: bold">end</span>
    <span style="color: #BBB">	</span><span style="color: #008000; font-weight: bold">end</span>

    <span style="color: #BBB">	</span><span style="color: #008000; font-weight: bold">local</span><span style="color: #BBB"> </span><span style="color: #19177C">path</span>,<span style="color: #BBB"> </span><span style="color: #19177C">pathSectorsPos</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #00F">GetPortalPath</span>(<span style="color: #19177C">sourcePos</span>,<span style="color: #BBB"> </span><span style="color: #19177C">targetPos</span>)

    <span style="color: #BBB">	</span><span style="color: #008000; font-weight: bold">if</span><span style="color: #BBB"> </span><span style="color: #19177C">path</span><span style="color: #BBB"> </span><span style="color: #666">==</span><span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">nil</span><span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">then</span>
    <span style="color: #BBB">		</span><span style="color: #008000; font-weight: bold">return</span><span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">nil</span>,<span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">nil</span>
    <span style="color: #BBB">	</span><span style="color: #008000; font-weight: bold">end</span>

    <span style="color: #BBB">	</span><span style="color: #008000; font-weight: bold">local</span><span style="color: #BBB"> </span><span style="color: #19177C">t</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #008000">os.clock</span>()
    <span style="color: #BBB">	</span><span style="color: #008000; font-weight: bold">local</span><span style="color: #BBB"> </span><span style="color: #19177C">prevFieldId</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">nil</span>
    <span style="color: #BBB">	</span><span style="color: #008000; font-weight: bold">local</span><span style="color: #BBB"> </span><span style="color: #19177C">fieldIdList</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span>{}
    <span style="color: #BBB">	</span><span style="color: #008000; font-weight: bold">for</span><span style="color: #BBB"> </span><span style="color: #19177C">idx</span>,<span style="color: #BBB"> </span><span style="color: #19177C">sectorPos</span><span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">in</span><span style="color: #BBB"> </span><span style="color: #19177C">pathSectorsPos</span><span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">do</span>
    <span style="color: #BBB">		</span><span style="color: #008000; font-weight: bold">local</span><span style="color: #BBB"> </span><span style="color: #19177C">sector</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">sectorGrid</span>[<span style="color: #19177C">sectorPos</span>.X][<span style="color: #19177C">sectorPos</span>.Y]
    <span style="color: #BBB">		</span><span style="color: #008000; font-weight: bold">local</span><span style="color: #BBB"> </span><span style="color: #19177C">chunk</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">debugChunk</span>[<span style="color: #19177C">sectorPos</span>.X][<span style="color: #19177C">sectorPos</span>.Y]

    <span style="color: #BBB">		</span><span style="color: #008000; font-weight: bold">local</span><span style="color: #BBB"> </span><span style="color: #19177C">startCells</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span>{}
    <span style="color: #BBB">		</span><span style="color: #008000; font-weight: bold">if</span><span style="color: #BBB"> </span><span style="color: #19177C">idx</span><span style="color: #BBB"> </span><span style="color: #666">==</span><span style="color: #BBB"> </span><span style="color: #666">1</span><span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">then</span>
    <span style="color: #BBB">			</span><span style="color: #008000; font-weight: bold">local</span><span style="color: #BBB"> </span><span style="color: #19177C">goalPos</span>,<span style="color: #BBB"> </span><span style="color: #19177C">_</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">Utils</span>.<span style="color: #00F">ConvertToLocalCellPos</span>(<span style="color: #19177C">targetPos</span>)
    <span style="color: #BBB">			</span><span style="color: #008000">table.insert</span>(<span style="color: #19177C">startCells</span>,<span style="color: #BBB"> </span>{<span style="color: #19177C">Pos</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">goalPos</span>,<span style="color: #BBB"> </span><span style="color: #19177C">Val</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #666">0</span>,<span style="color: #BBB"> </span><span style="color: #19177C">Flags</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">SectorInfo</span>.Flags.Goal})
    <span style="color: #BBB">		</span><span style="color: #008000; font-weight: bold">else</span>
    <span style="color: #BBB">			</span><span style="color: #008000; font-weight: bold">local</span><span style="color: #BBB"> </span><span style="color: #19177C">portalIdx</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span>(<span style="color: #19177C">idx</span><span style="color: #BBB"> </span><span style="color: #666">-</span><span style="color: #BBB"> </span><span style="color: #666">1</span>)<span style="color: #BBB"> </span><span style="color: #666">*</span><span style="color: #BBB"> </span><span style="color: #666">2</span>
    <span style="color: #BBB">			</span><span style="color: #008000; font-weight: bold">local</span><span style="color: #BBB"> </span><span style="color: #19177C">portal</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">path</span>[<span style="color: #19177C">portalIdx</span>]
    <span style="color: #BBB">			</span><span style="color: #008000; font-weight: bold">local</span><span style="color: #BBB"> </span><span style="color: #19177C">portalAdj</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">path</span>[<span style="color: #19177C">portalIdx</span><span style="color: #BBB"> </span><span style="color: #666">-</span><span style="color: #BBB"> </span><span style="color: #666">1</span>]
    <span style="color: #BBB">			</span><span style="color: #008000; font-weight: bold">local</span><span style="color: #BBB"> </span><span style="color: #19177C">sectorAdjPos</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">portalAdj</span>.SectorPos
    <span style="color: #BBB">			</span><span style="color: #008000; font-weight: bold">local</span><span style="color: #BBB"> </span><span style="color: #19177C">sectorAdj</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">sectorGrid</span>[<span style="color: #19177C">sectorAdjPos</span>.X][<span style="color: #19177C">sectorAdjPos</span>.Y]
    <span style="color: #BBB">			</span><span style="color: #008000; font-weight: bold">local</span><span style="color: #BBB"> </span><span style="color: #19177C">startOffset</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">dirs</span>[<span style="color: #19177C">portal</span>.Side<span style="color: #BBB"> </span><span style="color: #666">+</span><span style="color: #BBB"> </span><span style="color: #666">1</span>]

    <span style="color: #BBB">			</span><span style="color: #19177C">fieldId</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">Utils</span>.<span style="color: #00F">ConvertPortalPosToNumber</span>(<span style="color: #19177C">portal</span>.CellPos,<span style="color: #BBB"> </span><span style="color: #19177C">portal</span>.SectorPos,<span style="color: #BBB"> </span><span style="color: #19177C">portal</span>.Side)
    <span style="color: #BBB">			</span><span style="color: #008000; font-weight: bold">if</span><span style="color: #BBB"> </span><span style="color: #19177C">portalIdx</span><span style="color: #BBB"> </span><span style="color: #666">&lt;</span><span style="color: #BBB"> </span><span style="color: #666">#</span><span style="color: #19177C">path</span><span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">then</span>
    <span style="color: #BBB">				</span><span style="color: #008000; font-weight: bold">local</span><span style="color: #BBB"> </span><span style="color: #19177C">portalNext</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">path</span>[<span style="color: #19177C">portalIdx</span><span style="color: #BBB"> </span><span style="color: #666">+</span><span style="color: #BBB"> </span><span style="color: #666">1</span>]
    <span style="color: #BBB">				</span><span style="color: #19177C">fieldIdAdd</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">Utils</span>.<span style="color: #00F">ConvertPortalPosToNumber</span>(<span style="color: #19177C">portalNext</span>.CellPos,<span style="color: #BBB"> </span><span style="color: #19177C">portalNext</span>.SectorPos,<span style="color: #BBB"> </span><span style="color: #19177C">portalNext</span>.Side)
    <span style="color: #BBB">			</span><span style="color: #008000; font-weight: bold">else</span>
    <span style="color: #BBB">				</span><span style="color: #19177C">fieldIdAdd</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">fieldId</span>
    <span style="color: #BBB">			</span><span style="color: #008000; font-weight: bold">end</span>

    <span style="color: #BBB">			</span><span style="color: #19177C">fieldIdAdd</span><span style="color: #BBB"> </span><span style="color: #666">*=</span><span style="color: #BBB"> </span><span style="color: #19177C">idOffset</span>
    <span style="color: #BBB">			</span><span style="color: #19177C">fieldId</span><span style="color: #BBB"> </span><span style="color: #666">+=</span><span style="color: #BBB"> </span><span style="color: #19177C">fieldIdAdd</span>

    <span style="color: #BBB">			</span><span style="color: #008000; font-weight: bold">local</span><span style="color: #BBB"> </span><span style="color: #19177C">side</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">sector</span>:<span style="color: #00F">GetSideCosts</span>(<span style="color: #19177C">portal</span>.Side)
    <span style="color: #BBB">			</span><span style="color: #008000; font-weight: bold">local</span><span style="color: #BBB"> </span><span style="color: #19177C">sideRegions</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">sector</span>:<span style="color: #00F">GetSideRegions</span>(<span style="color: #19177C">portal</span>.Side)
    <span style="color: #BBB">			</span><span style="color: #008000; font-weight: bold">local</span><span style="color: #BBB"> </span><span style="color: #19177C">sideAdjRegions</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">sectorAdj</span>:<span style="color: #00F">GetSideRegions</span>(<span style="color: #19177C">portalAdj</span>.Side)
    <span style="color: #BBB">			</span><span style="color: #008000; font-weight: bold">local</span><span style="color: #BBB"> </span><span style="color: #19177C">sideAdj</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">sectorAdj</span>:<span style="color: #00F">GetSideCosts</span>(<span style="color: #19177C">portalAdj</span>.Side)
    <span style="color: #BBB">			</span><span style="color: #008000; font-weight: bold">local</span><span style="color: #BBB"> </span><span style="color: #19177C">sideAdjInt</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">sectorAdj</span>:<span style="color: #00F">GetSideIntegratedCosts</span>(<span style="color: #19177C">portalAdj</span>.Side,<span style="color: #BBB"> </span><span style="color: #19177C">prevFieldId</span>)
    <span style="color: #BBB">			</span><span style="color: #008000; font-weight: bold">local</span><span style="color: #BBB"> </span><span style="color: #19177C">sideAdjFlags</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">sectorAdj</span>:<span style="color: #00F">GetSideCellFlags</span>(<span style="color: #19177C">portalAdj</span>.Side,<span style="color: #BBB"> </span><span style="color: #19177C">prevFieldId</span>)

    <span style="color: #BBB">			</span><span style="color: #008000; font-weight: bold">local</span><span style="color: #BBB"> </span><span style="color: #19177C">minIntVal</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">SectorInfo</span>.MaxIntegratedCost
    <span style="color: #BBB">			</span><span style="color: #008000; font-weight: bold">for</span><span style="color: #BBB"> </span><span style="color: #19177C">i</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #666">1</span>,<span style="color: #BBB"> </span><span style="color: #19177C">cellCount</span><span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">do</span>
    <span style="color: #BBB">				</span><span style="color: #008000; font-weight: bold">if</span><span style="color: #BBB"> </span><span style="color: #19177C">sideAdjInt</span>[<span style="color: #19177C">i</span>]<span style="color: #BBB"> </span><span style="color: #666">&gt;=</span><span style="color: #BBB"> </span><span style="color: #19177C">SectorInfo</span>.MaxIntegratedCost<span style="color: #BBB"> </span><span style="color: #A2F; font-weight: bold">or</span><span style="color: #BBB"> </span><span style="color: #19177C">portal</span>.Region<span style="color: #BBB"> </span><span style="color: #666">~=</span><span style="color: #BBB"> </span><span style="color: #19177C">sideRegions</span>[<span style="color: #19177C">i</span>]<span style="color: #BBB"> </span><span style="color: #A2F; font-weight: bold">or</span><span style="color: #BBB"> </span><span style="color: #19177C">portalAdj</span>.Region<span style="color: #BBB"> </span><span style="color: #666">~=</span><span style="color: #BBB"> </span><span style="color: #19177C">sideAdjRegions</span>[<span style="color: #19177C">i</span>]<span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">then</span>
    <span style="color: #BBB">					</span><span style="color: #19177C">continue</span>
    <span style="color: #BBB">				</span><span style="color: #008000; font-weight: bold">end</span>

    <span style="color: #BBB">				</span><span style="color: #19177C">minIntVal</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #008000">math.min</span>(<span style="color: #19177C">minIntVal</span>,<span style="color: #BBB"> </span><span style="color: #19177C">sideAdjInt</span>[<span style="color: #19177C">i</span>])
    <span style="color: #BBB">			</span><span style="color: #008000; font-weight: bold">end</span>

    <span style="color: #BBB">			</span><span style="color: #008000; font-weight: bold">for</span><span style="color: #BBB"> </span><span style="color: #19177C">i</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #666">1</span>,<span style="color: #BBB"> </span><span style="color: #19177C">cellCount</span><span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">do</span>
    <span style="color: #BBB">				</span><span style="color: #008000; font-weight: bold">if</span><span style="color: #BBB"> </span><span style="color: #19177C">side</span>[<span style="color: #19177C">i</span>]<span style="color: #BBB"> </span><span style="color: #666">==</span><span style="color: #BBB"> </span><span style="color: #19177C">SectorInfo</span>.MaxCost<span style="color: #BBB"> </span><span style="color: #A2F; font-weight: bold">or</span><span style="color: #BBB"> </span><span style="color: #19177C">sideAdj</span>[<span style="color: #19177C">i</span>]<span style="color: #BBB"> </span><span style="color: #666">==</span><span style="color: #BBB"> </span><span style="color: #19177C">SectorInfo</span>.MaxCost<span style="color: #BBB"> </span><span style="color: #A2F; font-weight: bold">or</span><span style="color: #BBB"> </span><span style="color: #19177C">portal</span>.Region<span style="color: #BBB"> </span><span style="color: #666">~=</span><span style="color: #BBB"> </span><span style="color: #19177C">sideRegions</span>[<span style="color: #19177C">i</span>]<span style="color: #BBB"> </span><span style="color: #A2F; font-weight: bold">or</span><span style="color: #BBB"> </span><span style="color: #19177C">portalAdj</span>.Region<span style="color: #BBB"> </span><span style="color: #666">~=</span><span style="color: #BBB"> </span><span style="color: #19177C">sideAdjRegions</span>[<span style="color: #19177C">i</span>]<span style="color: #BBB"> </span><span style="color: #008000; font-weight: bold">then</span>
    <span style="color: #BBB">					</span><span style="color: #19177C">continue</span>
    <span style="color: #BBB">				</span><span style="color: #008000; font-weight: bold">end</span>
    <span style="color: #BBB">				</span>
    <span style="color: #BBB">				</span><span style="color: #008000">table.insert</span>(<span style="color: #19177C">startCells</span>,<span style="color: #BBB"> </span>{<span style="color: #19177C">Pos</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">sector</span>:<span style="color: #00F">GetCellPosFromSide</span>(<span style="color: #19177C">i</span>,<span style="color: #BBB"> </span><span style="color: #19177C">portal</span>.Side)<span style="color: #BBB"> </span><span style="color: #666">+</span><span style="color: #BBB"> </span><span style="color: #19177C">startOffset</span>,<span style="color: #BBB"> </span><span style="color: #19177C">Val</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">sideAdjInt</span>[<span style="color: #19177C">i</span>]<span style="color: #BBB"> </span><span style="color: #666">-</span><span style="color: #BBB"> </span><span style="color: #19177C">minIntVal</span>,<span style="color: #BBB"> </span><span style="color: #19177C">Flags</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">sideAdjFlags</span>[<span style="color: #19177C">i</span>]})
    <span style="color: #BBB">			</span><span style="color: #008000; font-weight: bold">end</span>
    <span style="color: #BBB">		</span><span style="color: #008000; font-weight: bold">end</span>

    <span style="color: #BBB">		</span><span style="color: #19177C">debug</span>.<span style="color: #00F">profilebegin</span>(<span style="color: #BA2121">&quot;Integration Field Calculation&quot;</span>)
    <span style="color: #BBB">		</span><span style="color: #008000; font-weight: bold">local</span><span style="color: #BBB"> </span><span style="color: #19177C">changed</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">sector</span>:<span style="color: #00F">CalculateIntegrationField</span>(<span style="color: #19177C">fieldId</span>,<span style="color: #BBB"> </span><span style="color: #19177C">startCells</span>,<span style="color: #BBB"> </span><span style="color: #19177C">targetPos</span>)
    <span style="color: #BBB">		</span><span style="color: #19177C">debug</span>.<span style="color: #00F">profileend</span>()
    <span style="color: #BBB">		</span><span style="color: #19177C">debug</span>.<span style="color: #00F">profilebegin</span>(<span style="color: #BA2121">&quot;Flow Field Calculation&quot;</span>)
    <span style="color: #BBB">		</span><span style="color: #19177C">sector</span>:<span style="color: #00F">CalculateFlowField</span>(<span style="color: #19177C">fieldId</span>,<span style="color: #BBB"> </span><span style="color: #19177C">changed</span>)
    <span style="color: #BBB">		</span><span style="color: #19177C">debug</span>.<span style="color: #00F">profileend</span>()

    <span style="color: #BBB">		</span><span style="color: #19177C">prevFieldId</span><span style="color: #BBB"> </span><span style="color: #666">=</span><span style="color: #BBB"> </span><span style="color: #19177C">fieldId</span>
    <span style="color: #BBB">		</span><span style="color: #008000">table.insert</span>(<span style="color: #19177C">fieldIdList</span>,<span style="color: #BBB"> </span><span style="color: #19177C">fieldId</span>)
    <span style="color: #BBB">	</span><span style="color: #008000; font-weight: bold">end</span>
    </pre></div>
</div>

<div class="infobox" data-title="References">
    <h1>References</h1>

    <ul>
        <li><a target="_blank" rel="noopener noreferrer" href="https://www.gameaipro.com/GameAIPro/GameAIPro_Chapter23_Crowd_Pathfinding_and_Steering_Using_Flow_Field_Tiles.pdf">GameAIPro Chapter 23</a></li>
        <li><a target="_blank" rel="noopener noreferrer" href="https://github.com/BlondeBurrito/bevy_flowfield_tiles_plugin?tab=readme-ov-file">Bevy Flowfield Tiles Plugin</a></li>
        <li><a target="_blank" rel="noopener noreferrer" href="https://anderamo.wordpress.com/wp-content/uploads/2015/02/cs380_researchpaper_flockingflowfieldpathfining1.pdf">Research Paper on Flocking Flowfield Pathfining</a></li>
    </ul>
</div>

<div class="infobox" data-title="About">
    <h1>About</h1>
    <p>Acesta este un proiect pentru atestatul de la informatic n care prezint un algoritm de pathfinding
        pe care am intenionat sa l utilizez ntr-un joc de strategie n timp real care n-a fost s fie. :')</p>
    <p>Am folosit siteul <a href="https://hilite.me/">hilite.me</a> pentru poriunile n care prezint codul surs al algoritmului.</p>

    <div style="text-align: center">
        <img src="img/asdf.png" alt="">
    </div>
</div>

<script>
    function getCookie(name) {
        let decodedCookie = decodeURIComponent(document.cookie);
        let cookieList = decodedCookie.split(';');
        for(i = 0; i < cookieList.length; i++) {
            let c = cookieList[i].trim();

            let nameValPair = c.split('=');
            if(nameValPair[0] === name) {
                return nameValPair[1];
            }
        }

        return "";
    }

    function setCookie(name, val) {
        document.cookie = name + '=' + val;
    }

    let infoboxTitle = getCookie("infobox-title");
    if(infoboxTitle === "") {
        document.cookie = "infobox-title=Introduction";
        infoboxTitle = "Introduction";
    }

    let boxes = document.getElementsByClassName("infobox");
    let selectedBox;
    for(i = 0; i < boxes.length; i++) {
        if(boxes[i].dataset.title === infoboxTitle) {
            boxes[i].style.display = "block";
            selectedBox = boxes[i];
        }
        else {
            boxes[i].style.display = "none";
        }
    }

    function changePage(element) {
        let box = document.querySelector('[data-title="' + element.text + '"]');
        selectedBox.style.display = "none";
        box.style.display = "block";
        selectedBox = box;
        setCookie("infobox-title", element.text);
    }
</script>

</body>
</html>

